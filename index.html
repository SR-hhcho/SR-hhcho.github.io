<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#1b64da" />
<title>ì—…ë¬´ìš© ìš´í–‰ê¸°ë¡</title>

<!-- í°íŠ¸ -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.css"
      crossorigin>

<!-- íŒŒë¹„ì½˜ -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><rect width='128' height='128' rx='24' fill='%231b64da'/><text x='50%' y='58%' text-anchor='middle' dominant-baseline='middle' font-family='Arial' font-size='84' fill='white'>ì°¨</text></svg>'>

<style>
:root{
  --bg:#f7f8fa; --card:#fff; --text:#111; --sub:#717680; --line:#e5e8eb;
  --blue:#1b64da; --blue-press:#1552b3; --ok:#12b886; --err:#f03e3e;
  --chip:#eef2ff; --chip-border:#dbe6ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:#e5e7eb;color:var(--text);
  font-family:"Pretendard Variable",Pretendard,-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial,system-ui,sans-serif;
}
.wrap{
  min-height:100%;
  display:flex;
  flex-direction:column;
  max-width:480px;
  margin:0 auto;
  background:var(--bg);
}

/* ì•±ë°” */
.appbar{position:sticky;top:0;z-index:60;height:56px;background:#fff;border-bottom:1px solid var(--line);
  display:grid;grid-template-columns:56px 1fr 56px;align-items:center}
.appbtn{display:flex;align-items:center;justify-content:center;height:56px;color:#1b64da;text-decoration:none;font-weight:800}
.apptitle{justify-self:center;font-weight:900;font-size:17px;letter-spacing:-0.3px}
.apptitle a{color:inherit;text-decoration:none}

/* ì„¹ì…˜ íƒ€ì´í‹€ */
.section-title{margin:10px 16px 4px;font-weight:900;color:#1b64da;font-size:13px}

/* ì•ˆë‚´ ìº¡ì…˜ */
.caption{color:var(--sub);font-size:13px;margin:6px 16px 8px}

/* ì¹´ë“œ/í¼ */
.card{background:#fff;margin:8px 12px;padding:14px;border-radius:14px;box-shadow:0 6px 24px rgba(17,17,17,.06)}
.row{display:flex;gap:8px}
label{display:block;font-size:12px;color:var(--sub);margin:8px 2px 4px}
label.req::after{content:" *";color:#1b64da;font-weight:900}
input,textarea,select{
  width:100%;font-size:16px;padding:12px 12px;border-radius:12px;border:1px solid var(--line);
  background:#fff;outline:none;transition:border .15s,box-shadow .15s;font-family:inherit
}
input:focus,textarea:focus,select:focus{border-color:#b4c6ff;box-shadow:0 0 0 3px rgba(27,100,218,.15)}
textarea{height:44px;resize:none}

/* ìš´í–‰ì „ km ë°°ì§€ */
.prevkm{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:#1e40af;
  border:1px solid var(--chip-border);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;margin-top:6px}

/* ìš°ì¸¡ ë¯¸ì„¸ ì•ˆë‚´ */
.micro{margin-top:6px;margin-left:auto;color:#95a1ad;font-size:12px}

/* ë²„íŠ¼/ì•¡ì…˜ */
.actions{display:flex;gap:8px;margin:8px 12px;flex-wrap:wrap}
.btn{
  appearance:none;border:1px solid var(--line);background:#fff;color:#374151;border-radius:12px;
  padding:10px 14px;font-size:14px;font-weight:800;text-decoration:none;
  display:inline-flex;align-items:center;gap:8px;cursor:pointer;justify-content:center;
}
.btn:hover{filter:brightness(0.98)}
.btn.ghost{background:#fff}
.sticky{position:sticky;bottom:64px;padding:10px 12px 16px;background:linear-gradient(180deg,rgba(247,248,250,0),var(--bg) 30%);margin-top:auto}
button.primary{width:100%;border:none;border-radius:14px;padding:14px 18px;font-size:17px;font-weight:900;color:#fff;background:var(--blue);box-shadow:0 10px 24px rgba(27,100,218,.25);cursor:pointer}
button.primary:active{background:var(--blue-press)}

/* í™ˆ íƒ€ì¼ */
.list{display:flex;flex-direction:column;gap:10px;margin:8px 12px 84px}
.tile{
  background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;
  text-decoration:none;color:#111;display:flex;align-items:center;gap:10px;
  box-shadow:0 4px 14px rgba(0,0,0,.04)
}
.tile img{width:56px;height:36px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
.tile-main{flex:1;display:flex;align-items:center;gap:10px;min-width:0}
.tile-plate{font-weight:900;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tile-id{
  font-size:12px;font-weight:800;color:#1e40af;background:#eef2ff;padding:4px 10px;
  border-radius:999px;border:1px solid #dbe6ff;white-space:nowrap
}
.tile-qr{
  margin-left:auto;min-width:72px;height:38px;border-radius:999px;border:1.5px dashed #c7d2fe;
  color:#1d4ed8;font-size:13px;font-weight:900;background:#f8fbff;
}

/* íˆìŠ¤í† ë¦¬ ì¹´ë“œ ê³µí†µ */
.history{margin:8px 12px 84px;padding:10px;border:1px solid var(--line);border-radius:14px;background:#fff}
.hitem{display:flex;gap:12px;align-items:flex-start;padding:12px 4px;border-bottom:1px dashed var(--line)}
.hitem:last-child{border-bottom:none}

/* ì™¼ìª½ ë™ê·¸ë€ km ë±ƒì§€ */
.kmcircle{
  min-width:48px;min-height:48px;border-radius:50%;
  background:#eef2ff;border:1.5px solid #c7d2fe;color:#1e40af;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;font-size:12px;box-shadow:0 4px 12px rgba(59,130,246,.08)
}

/* ê°€ìš´ë° ë³¸ë¬¸(3ì¤„) */
.hcell{flex:1;min-width:0}
.hrow1{display:flex;justify-content:space-between;gap:8px}
.hrow1 .title{font-weight:900;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hrow1 .metaR{color:#64748b;font-size:12px;white-space:nowrap}
.hrow2{color:#374151;font-size:12.5px;line-height:1.3;word-break:keep-all}
.hrow2 .postkm{font-weight:900;color:#111;margin-left:6px}
.hrow3{color:#6b7280;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* ì‚­ì œ ë²„íŠ¼ ì‘ê²Œ */
.btn.small{padding:6px 10px;font-size:12px}

/* ===== ì°¨ëŸ‰ í—¤ë”(ë°°ì§€ + ì„¤ëª…) ===== */
.head-card{display:flex;gap:12px;align-items:center}

/* ğŸ‘‰ ì—¬ê¸° ë°°ì§€ í¬ê¸° ì¤„ì¸ ë¶€ë¶„ */
.vchip2{
  min-width:88px;
  max-width:88px;
  height:54px;
  border-radius:12px;
  background:var(--chip);
  border:1px solid var(--chip-border);
  color:#1e40af;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  line-height:1.1;
  font-weight:900;
  box-shadow:0 4px 12px rgba(0,0,0,.04);
  padding:4px 4px;
  text-align:center;
}
.vchip2 .plate{
  font-size:12px;
  max-width:80px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.vchip2 .vid{font-size:10px;margin-top:1px;opacity:.9}

/* ì˜¤ë¥¸ìª½ ì„¤ëª…(í°íŠ¸ 1pt ì¤„ì„) */
.head-desc{
  margin-left:8px;
  max-width:calc(100% - 112px);
  font-size:11px;line-height:1.4;color:#4b5563
}

/* í•˜ë‹¨ íƒ­ë°” */
.tabbar{position:fixed;left:0;right:0;bottom:0;height:64px;background:#fff;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(4,1fr);z-index:50}
.tab{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:#6b7684;text-decoration:none;font-size:11px;font-weight:800}
.tab.on{color:#1b64da}
.ico{width:20px;height:20px}

/* í† ìŠ¤íŠ¸ */
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#fff;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.08);padding:10px 12px;border-radius:12px;font-size:14px;display:none;z-index:9999}
.toast.ok{border-color:#b2f2bb;color:#0c7;background:#f6fffa;display:block}
.toast.err{border-color:#ffc9c9;color:#d11;background:#fff5f5;display:block}

/* ë¡œë”© ì˜¤ë²„ë ˆì´ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9998}
.overlay.show{display:flex}
.overlay .box{background:#fff;padding:18px 20px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.12);display:flex;flex-direction:column;align-items:center;gap:10px;min-width:220px}
.spinner{width:28px;height:28px;border:3px solid #e5e8eb;border-top-color:#1b64da;border-radius:50%;animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.overlay .msg{font-weight:700;font-size:14px;color:#111}
.overlay .sub{font-size:12px;color:#6b7684;text-align:center}

/* QR ëª¨ë‹¬ */
.qr-modal{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  display:none;align-items:center;justify-content:center;
  z-index:9997;
}
.qr-modal.show{display:flex}
.qr-box{
  background:#fff;border-radius:18px;padding:18px 16px 16px;
  max-width:360px;width:88%;box-shadow:0 18px 40px rgba(0,0,0,.28);
  text-align:center;
}
.qr-title{font-weight:800;font-size:15px;margin-top:4px}
#qrImg{
  display:block;
  margin:18px auto 8px;
  max-width:260px;
  width:80%;
  height:auto;
}
.qr-actions{display:flex;gap:8px;margin-top:10px}
.qr-actions .btn{flex:1}

/* ìš´í–‰ì¼ì§€ ìš”ì•½ ì¹´ë“œ */
.summary-list{margin:8px 12px 84px;display:flex;flex-direction:column;gap:10px}
.summary-item{background:#fff;border-radius:14px;border:1px solid var(--line);padding:12px 14px;box-shadow:0 4px 14px rgba(0,0,0,.04)}
.summary-title{font-weight:900;margin-bottom:4px}
.summary-sub{font-size:13px;color:#4b5563}

/* ë°ìŠ¤í¬í†± ê²½ê³  ë°°ë„ˆ */
@media (min-width:900px){
  .desktop-warning{
    position:fixed;top:56px;left:0;right:0;
    background:#fff3cd;color:#856404;
    padding:6px 10px;font-size:12px;text-align:center;
    z-index:40;border-bottom:1px solid #ffeeba;
  }
}
</style>
</head>
<body>
<div class="wrap">
  <div class="appbar">
    <a class="appbtn" href="#/"><svg class="ico" viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z" fill="currentColor"/></svg></a>
    <div class="apptitle"><a href="#/">ì—…ë¬´ìš© ìš´í–‰ê¸°ë¡</a></div>
    <div></div>
  </div>

  <div id="desktopWarning" class="desktop-warning" style="display:none">
    ì´ í˜ì´ì§€ëŠ” ëª¨ë°”ì¼ í™”ë©´ì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì…ë ¥ì€ ê°€ê¸‰ì  íœ´ëŒ€í°ì—ì„œ ì§„í–‰í•´ì£¼ì„¸ìš”.
  </div>

  <div id="page"></div>
  <div id="toast" class="toast"></div>

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="box">
      <div class="spinner"></div>
      <div class="msg">ì²˜ë¦¬ ì¤‘â€¦</div>
      <div class="sub">ì„œë²„ê°€ ê¸°ë¡ì„ ì €ì¥í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤.<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
    </div>
  </div>

  <!-- QR ëª¨ë‹¬ -->
  <div id="qrModal" class="qr-modal" aria-hidden="true">
    <div class="qr-box">
      <div id="qrTitle" class="qr-title">QR</div>
      <img id="qrImg" alt="QR ì½”ë“œ" />
      <div class="qr-actions">
        <button type="button" class="btn" id="qrDownload">ë‹¤ìš´ë¡œë“œ</button>
        <button type="button" class="btn ghost" id="qrClose">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- í•˜ë‹¨ íƒ­ -->
<nav class="tabbar">
  <a href="#/" class="tab" id="tab-home"><svg class="ico" viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z" fill="currentColor"/></svg>HOME</a>
  <a href="#/sheet" class="tab" id="tab-sheet"><svg class="ico" viewBox="0 0 24 24"><path d="M5 3h10l4 4v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm10 1v4h4" fill="currentColor"/></svg>ìš´í–‰ì¼ì§€</a>
  <a href="#/recent" class="tab" id="tab-recent"><svg class="ico" viewBox="0 0 24 24"><path d="M12 8v5l4 2M4 12a8 8 0 1 0 8-8" stroke="currentColor" fill="none" stroke-width="2"/></svg>ìµœê·¼ê¸°ë¡</a>
  <a href="#/more" class="tab" id="tab-more"><svg class="ico" viewBox="0 0 24 24"><circle cx="5" cy="12" r="2" fill="currentColor"/><circle cx="12" cy="12" r="2" fill="currentColor"/><circle cx="19" cy="12" r="2" fill="currentColor"/></svg>ë”ë³´ê¸°</a>
</nav>

<script>
/* ===== ì„¤ì • ===== */
const WEBHOOK_URL  = "https://hook.us2.make.com/95cj2g36m4tsgu82h1bu41gf4swboiks";
const DELETE_URL   = "https://hook.us2.make.com/j2naw84osfkadkga7xkrljj8ep6rvroh";
const LOGS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLnxKDu-UGxyHZ86d5HS6G9_aFRvD5TEYFyMmqR-oFogtT1iNvhB08_BciXL2KsepJ_VihsO4qHVnF/pub?gid=0&single=true&output=csv";
const CONTACTS_CSV_URL = "";

/* ì°¨ëŸ‰ ë“±ë¡ + ì°¨ì¢… */
const VEHICLES = [
  { id:"V001", name:"806ì¡°8193", img:"img/V001.jpg", type:"ìŠ¤íƒ€ë¦¬ì•„" },
  { id:"V002", name:"81ë‘1166", img:"img/V002.jpg", type:"ìŠ¤íƒ€ë ‰ìŠ¤" },
  { id:"V003", name:"804ë„ˆ3147", img:"img/V003.jpg", type:"ìŠ¤íƒ€ë¦¬ì•„" }
];

/* í—ˆìš© ëª©ë¡(ì „ì—­) */
const NAME_ALLOW = ["ê¹€í•™ì² ","ìµœì¢…ìš°","ê¶Œì² ìš´","ì´ìŠ¹í›ˆ","ê¶Œíƒœêµ­","ìœ¤ì¢…ì„ ","í•œë™í›ˆ","ë°•ë‚¨ì£¼","ë‚¨ê´‘í˜„","ê¹€ëŒ€í˜„","ì›ë™ì„­","ì¡°í•­í˜„"];
const DEPT_ALLOW = ["ì•ˆì „ê´€ë¦¬íŒ€","ì•ˆì „ê¸°ìˆ íŒ€","ì˜ì—…ê³µë¬´íŒ€"];

/* ===== ìœ í‹¸ ===== */
const el=(s,p=document)=>p.querySelector(s);
const ce=(t,o={})=>Object.assign(document.createElement(t),o);
const toast=(m,ok=true)=>{const t=el('#toast');t.textContent=m;t.className='toast '+(ok?'ok':'err');setTimeout(()=>t.className='toast',2200);};
function setTab(name){['home','sheet','recent','more'].forEach(k=>el('#tab-'+k)?.classList.toggle('on',k===name));}
function section(title){return ce('div',{className:'section-title',textContent:title});}
function setLoading(on,msg){const ov=el('#overlay');if(!ov) return;ov.classList.toggle('show',!!on);if(msg) ov.querySelector('.msg').textContent=msg;document.querySelectorAll('input,textarea,button,select').forEach(e=>e.disabled=!!on);}

/* ë°ìŠ¤í¬í†± ê²½ê³  */
(function(){
  const w = el('#desktopWarning');
  if(window.innerWidth>900) w.style.display='block';
})();

/* CSV ê³µí†µ */
function fetchCsv(done,force){
  if(!LOGS_CSV_URL){ done([['ê¸°ë¡ì‹œê°','ì°¨ëŸ‰ID','ì°¨ëŸ‰ëª…','ì‚¬ìš©ìID','ì‚¬ìš©ìëª…','ê³„ê¸°íŒ_km','ì¼ìš´í–‰_km','ë©”ëª¨','ë¶€ì„œ']]); return; }
  const url=LOGS_CSV_URL+(/\?/.test(LOGS_CSV_URL)?'&':'?')+'nocache='+(force?Date.now():'0');
  fetch(url).then(r=>r.text()).then(t=>done(parseCSV(t))).catch(()=>done([['ê¸°ë¡ì‹œê°','ì°¨ëŸ‰ID','ì°¨ëŸ‰ëª…','ì‚¬ìš©ìID','ì‚¬ìš©ìëª…','ê³„ê¸°íŒ_km','ì¼ìš´í–‰_km','ë©”ëª¨','ë¶€ì„œ']]));
}
function parseCSV(text){
  const rows=[];let row=[],cell='',q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(q){ if(c==='"'&&n!='"'){q=false;continue;} if(c==='"'&&n==='"'){cell+='"';i++;continue;} cell+=c; continue; }
    if(c===','){ row.push(cell); cell=''; continue; }
    if(c==='\n'){ row.push(cell); rows.push(row); row=[]; cell=''; continue; }
    if(c==='"'){ q=true; continue; }
    if(c!=='\r') cell+=c;
  }
  row.push(cell); rows.push(row); return rows;
}

/* ===== QR ê´€ë ¨ ===== */
function buildVehicleUrl(id){
  const base = location.origin + location.pathname;
  if(!id) return base + "#/";
  return base + "#/" + encodeURIComponent(id);
}
function openQrModalForVehicle(v){
  const url = buildVehicleUrl(v.id);
  const title = `${v.name} (${v.id}) í˜ì´ì§€ QR`;
  openQrModal(title, url, `${v.id}.png`);
}
function openHomeQrModal(){
  const url = buildVehicleUrl(null);
  openQrModal("HOME í™”ë©´ QR", url, "home.png");
}
function openQrModal(title, dataUrl, filename){
  const modal = el('#qrModal');
  const img   = el('#qrImg');
  const ttl   = el('#qrTitle');
  ttl.textContent = title;
  const api = "https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=" + encodeURIComponent(dataUrl);
  img.src = api;
  img.dataset.downloadName = filename || "qr.png";
  modal.classList.add('show');
}
el('#qrClose').onclick = ()=>{ el('#qrModal').classList.remove('show'); };
el('#qrModal').addEventListener('click',e=>{
  if(e.target===e.currentTarget) el('#qrModal').classList.remove('show');
});
el('#qrDownload').onclick = ()=>{
  const img = el('#qrImg');
  if(!img.src) return;
  const a=document.createElement('a');
  a.href=img.src;
  a.download=img.dataset.downloadName||'qr.png';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};

/* ===== 10ì´ˆ ìë™ ìƒˆë¡œê³ ì¹¨(ìµœê·¼/ì°¨ëŸ‰) ===== */
var _pollTimer = null;
var _lastStamp = '';
function calcStamp(rows, vehicle){
  if (!rows || rows.length<=1) return '';
  if (vehicle){
    for(let i=rows.length-1;i>=1;i--){
      const r=rows[i];
      if ((r[1]||'').toUpperCase()===vehicle) {
        return String(r[0]||'') + '|' + String(r[5]||'') + '|' + String(r[6]||'');
      }
    }
    return '';
  }else{
    const r = rows[rows.length-1] || [];
    return String(r[0]||'') + '|' + String(r[1]||'') + '|' + String(r[5]||'') + '|' + String(r[6]||'');
  }
}
function startPolling(key){
  if (_pollTimer){ clearInterval(_pollTimer); _pollTimer=null; }
  if (!key){ _lastStamp=''; return; }

  const isVehicle = key && key.startsWith('VEH:');
  const vehicle = isVehicle ? key.slice(4) : null;

  fetchCsv(rows=>{ _lastStamp = calcStamp(rows, vehicle); }, true);

  _pollTimer = setInterval(()=>{
    fetchCsv(rows=>{
      const now = calcStamp(rows, vehicle);
      if (now && now !== _lastStamp){
        _lastStamp = now;
        if (isVehicle){ loadHistory(vehicle,true); }
        else if (key==='RECENT'){ renderRecentTab(); }
      }
    }, true);
  }, 10000);
}

/* ===== ë¼ìš°í„° ===== */
function route(){
  const seg=(location.hash||'#/').slice(2).split('/').filter(Boolean);
  const first=seg[0]||'';
  if(!first){ renderHome(); setTab('home'); startPolling(null); return; }
  if(first==='sheet'){ renderSheetTab(); setTab('sheet'); startPolling(null); return; }
  if(first==='recent'){ renderRecentTab(); setTab('recent'); startPolling('RECENT'); return; }
  if(first==='more'){ renderMoreTab(); setTab('more'); startPolling(null); return; }
  renderVehicle(first.toUpperCase()); setTab('home'); startPolling('VEH:'+first.toUpperCase());
}
window.addEventListener('hashchange',route);
if(!location.hash) location.hash = '#/';  // ê¸°ë³¸ í™ˆ ì§„ì…
route();

/* ===== í™ˆ ===== */
function renderHome(){
  const page=el('#page'); page.innerHTML='';
  const p1=ce('p',{className:'caption',textContent:'ì°¨ëŸ‰ì„ ì„ íƒí•´ ê¸°ë¡í•˜ì„¸ìš”.'});
  const list=ce('div',{className:'list'});
  VEHICLES.forEach(v=>{
    const tile=ce('div',{className:'tile'});
    const img=ce('img',{src:v.img||'',alt:v.name});
    img.onerror=function(){this.style.visibility='hidden';};
    const main=ce('a',{className:'tile-main',href:'#/'+encodeURIComponent(v.id)});
    const plate=ce('div',{className:'tile-plate',textContent:v.name});
    const idbadge=ce('span',{className:'tile-id',textContent:v.id});
    main.append(img,plate,idbadge);

    const qrBtn=ce('button',{className:'btn tile-qr',type:'button'});
    qrBtn.textContent='QR';
    qrBtn.onclick=(e)=>{e.stopPropagation();e.preventDefault();openQrModalForVehicle(v);};

    tile.append(main,qrBtn);
    list.append(tile);
  });
  page.append(p1,list);
}

/* ===== ì°¨ëŸ‰ í˜ì´ì§€ ===== */
function renderVehicle(vehicle){
  const v = VEHICLES.find(x=>x.id===vehicle) || {id:vehicle,name:'',type:''};
  const page = el('#page');
  page.innerHTML = '';

  /* í—¤ë”(ë°°ì§€ + ì„¤ëª…) */
  const head = ce('div',{className:'card head-card'});
  const vchip = ce('div',{className:'vchip2'});
  vchip.innerHTML = `
    <div class="plate">${v.name || vehicle}</div>
    <div class="vid">${v.id}${v.type ? " ("+v.type+")" : ""}</div>
  `;
  const desc = ce('div',{className:'head-desc'});
  desc.innerHTML = `ìš´í–‰í›„ kmì™€ ìš´í–‰ëª©ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>ì´ë¦„/ë¶€ì„œëŠ” ìµœì´ˆ 1íšŒë§Œ ì €ì¥í•˜ì‹œë©´ ë©ë‹ˆë‹¤.`;
  head.append(vchip, desc);
  page.append(head);

  /* ì…ë ¥ ì¹´ë“œ */
  const card = ce('div',{className:'card'});

  const row = ce('div',{className:'row'});
  const nameSel = ce('select',{id:'userName'});
  nameSel.append(ce('option',{value:'',textContent:'ì„±ëª… ì„ íƒ'}));
  NAME_ALLOW.forEach(n=>nameSel.append(ce('option',{value:n,textContent:n})));

  const deptSel = ce('select',{id:'dept'});
  deptSel.append(ce('option',{value:'',textContent:'ë¶€ì„œ ì„ íƒ'}));
  DEPT_ALLOW.forEach(d=>deptSel.append(ce('option',{value:d,textContent:d})));

  row.append(
    fieldLabelled('ì„±ëª…', nameSel, true),
    fieldLabelled('ë¶€ì„œ', deptSel, true)
  );
  card.append(row);

  const row2 = ce('div',{className:'row'});
  const odoI  = ce('input',{id:'odo',type:'number',inputMode:'numeric',placeholder:'ì˜ˆ) 21840'});
  const memoI = ce('textarea',{id:'memo',placeholder:'ì‹œì„¤ì ê²€ ë“±'});
  row2.append(fieldLabelled('ìš´í–‰ í›„ km(ìˆ«ì)', odoI, true), field('ë¹„ê³ (ì„ íƒ)', memoI));
  card.append(row2);

  const meta = ce('div',{style:'display:flex;align-items:center;gap:8px'});
  const prevBadge = ce('span',{className:'prevkm',textContent:'ìš´í–‰ ì „: í™•ì¸ì¤‘â€¦'});
  const micro = ce('div',{className:'micro',textContent:'ë‚´ ì •ë³´ëŠ” ì´ ê¸°ê¸°ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.'});
  meta.append(prevBadge, micro);
  card.append(meta);
  page.append(card);

  const actions = ce('div',{className:'actions'});
  const backBtn = ce('a',{className:'btn ghost',href:'#/'}); backBtn.textContent='â† í™ˆìœ¼ë¡œ';
  const resetBtn= ce('button',{className:'btn',type:'button'}); resetBtn.textContent='ë‚´ ì •ë³´ ì´ˆê¸°í™”';
  const refreshBtn= ce('button',{className:'btn',type:'button'}); refreshBtn.textContent='ìƒˆë¡œê³ ì¹¨';
  actions.append(backBtn, resetBtn, refreshBtn);
  page.append(actions);

  const sticky = ce('div',{className:'sticky'});
  const submit = ce('button',{className:'primary',textContent:'ì œì¶œí•˜ê¸°',type:'button'});
  sticky.append(submit);
  page.append(sticky);

  const keyN='drive_userName', keyD='drive_dept';
  const savedN=localStorage.getItem(keyN), savedD=localStorage.getItem(keyD);
  if(savedN && NAME_ALLOW.includes(savedN)) nameSel.value=savedN;
  if(savedD && DEPT_ALLOW.includes(savedD)) deptSel.value=savedD;

  resetBtn.onclick=()=>{
    localStorage.removeItem(keyN); localStorage.removeItem(keyD);
    nameSel.value=''; deptSel.value='';
    toast('ì €ì¥ëœ ì´ë¦„/ë¶€ì„œë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
  };

  refreshBtn.onclick=()=>{
    setLoading(true,'ìƒˆë¡œê³ ì¹¨ ì¤‘â€¦');
    refreshPrev(true);
    loadHistory(vehicle,true);
    setTimeout(()=>setLoading(false),400);
  };

  odoI.addEventListener('focus',()=>setTimeout(()=>odoI.scrollIntoView({behavior:'smooth',block:'center'}),150));

  submit.onclick = async () => {
    const userName = nameSel.value;
    const dept     = deptSel.value;
    const odo      = odoI.value.trim();
    const memo     = memoI.value.trim();

    if(!userName){ toast('ì„±ëª…ì„ ì„ íƒí•´ì£¼ì„¸ìš”', false); nameSel.focus(); return; }
    if(!dept){     toast('ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', false);  deptSel.focus(); return; }
    if(!odo || isNaN(+odo)){ toast('ìš´í–‰ í›„ km(ìˆ«ì)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', false); odoI.focus(); return; }
    if(!NAME_ALLOW.includes(userName)){ toast('ì„±ëª…ì€ ëª©ë¡ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.', false); nameSel.focus(); return; }
    if(!DEPT_ALLOW.includes(dept)){     toast('ë¶€ì„œëŠ” ëª©ë¡ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.', false);  deptSel.focus(); return; }

    localStorage.setItem(keyN,userName);
    localStorage.setItem(keyD,dept);

    let beforeCount=0;
    await new Promise(res=>fetchCsv(rows=>{
      beforeCount = rows.filter((r,i)=>i>0 && String(r[1]||'').toUpperCase()===vehicle).length;
      res();
    }, true));

    setLoading(true,'ê¸°ë¡ì„ ì €ì¥í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦');

    try{
      const resp = await fetch(WEBHOOK_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({vehicle,userName,dept,odo,memo})
      });
      if(!resp.ok) throw new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');

      const ok = await waitUntilUpdated(vehicle,beforeCount,15000);

      odoI.value=''; memoI.value=''; odoI.focus();
      await refreshPrev(true);
      loadHistory(vehicle,true);
      setTimeout(()=>{ refreshPrev(true); loadHistory(vehicle,true); },1200);

      toast(ok ? 'ì „ì†¡ ì™„ë£Œ! âœ…' : 'ì „ì†¡ì€ ì™„ë£Œ, ë°˜ì˜ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.', ok);
    }catch(e){
      toast('ì „ì†¡ ì‹¤íŒ¨: '+e.message, false);
    }finally{
      setLoading(false);
    }
  };

  // ğŸš— ìš´í–‰ ì „ km = ê°€ì¥ ìµœê·¼ ë¡œê·¸ì˜ "ì£¼í–‰í›„ km"
  async function refreshPrev(force){
    return new Promise(res=>{
      fetchCsv(rows=>{
        let last=null;
        for(let i=rows.length-1;i>=1;i--){
          const r=rows[i];
          if(String(r[1]||'').toUpperCase()===vehicle){ last=r; break; }
        }
        if(last){
          const post=Number(last[5]||'');
          prevBadge.textContent = Number.isFinite(post)? `ìš´í–‰ ì „: ${post} km` : 'ìš´í–‰ ì „: â€”';
        }else{
          prevBadge.textContent='ìš´í–‰ ì „: (ì²« ê¸°ë¡)';
        }
        res();
      }, force);
    });
  }
  refreshPrev();

  // ì°¨ëŸ‰ë³„ ìµœê·¼ ê¸°ë¡ ì¹´ë“œ
  const histCard=ce('div',{className:'history'});
  histCard.append(ce('div',{className:'section-title',textContent:'ìµœê·¼ ê¸°ë¡'}));
  histCard.append(ce('div',{id:'histBody'}));
  page.insertBefore(histCard, sticky);
  loadHistory(vehicle);

  startPolling('VEH:'+vehicle);
}

/* ===== ìš´í–‰ì¼ì§€ íƒ­ : ì°¨ëŸ‰ë³„ ì´ km ===== */
function renderSheetTab(){
  const page=el('#page'); page.innerHTML='';
  page.append(section('ìš´í–‰ì¼ì§€ ìš”ì•½'));
  page.append(ce('p',{className:'caption',textContent:'Logs ê¸°ì¤€ìœ¼ë¡œ ì°¨ëŸ‰ë³„ ì´ ìš´í–‰ê±°ë¦¬(km)ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.'}));

  const list=ce('div',{className:'summary-list'});
  fetchCsv(rows=>{
    const sumByVeh={};
    rows.forEach((r,i)=>{
      if(i===0) return;
      const vid=(r[1]||'').toUpperCase();
      const day=Number(r[6]||0);
      if(!Number.isFinite(day)) return;
      sumByVeh[vid]=(sumByVeh[vid]||0)+day;
    });
    VEHICLES.forEach(v=>{
      const total=sumByVeh[v.id]||0;
      const item=ce('div',{className:'summary-item'});
      item.innerHTML=`
        <div class="summary-title">${v.name} (${v.id}, ${v.type})</div>
        <div class="summary-sub">ì´ ìš´í–‰ê±°ë¦¬: <strong>${total.toLocaleString()} km</strong></div>
      `;
      list.append(item);
    });
  });
  page.append(list);
}

/* ===== ìµœê·¼ê¸°ë¡ íƒ­ ===== */
function renderRecentTab(){
  const page=el('#page'); page.innerHTML='';
  page.append(section('ìµœê·¼ê¸°ë¡'));
  const box=ce('div',{className:'history'}); box.innerHTML='<div id="recentList"></div>';
  const pager=ce('div',{className:'pager',id:'pager'});
  page.append(box,pager);

  fetchCsv(rows=>{
    const items=rows.filter((r,i)=>i>0).reverse();
    const per=10, maxPages=Math.min(5,Math.ceil(items.length/per)||1);
    let cur=1;
    function draw(){
      const slice=items.slice((cur-1)*per,(cur-1)*per+per);
      el('#recentList').innerHTML = slice.map(r=>{
        const date  = fmtDateSmart(r[0]||'');
        const vid   = (r[1]||'').toUpperCase();
        const vObj  = VEHICLES.find(v=>v.id===vid);
        const vname = vObj ? `${vObj.name} (${vObj.id})` : vid;
        const name  = r[4]||'', dept=r[8]||'';
        const post  = Number(r[5]||0);
        const day   = Number(r[6]||0);
        const memo  = r[7]||'';
        return `
          <div class="hitem">
            <div class="kmcircle">${Number.isFinite(day)&&day>0 ? `${day}km` : 'â€”'}</div>
            <div class="hcell">
              <div class="hrow1">
                <div class="title">${name} Â· ${dept}</div>
                <div class="metaR">${vname}</div>
              </div>
              <div class="hrow2">${memo ? `${memo}` : ''}<span class="postkm">${Number.isFinite(post)?`ì£¼í–‰í›„ ${post}km`:''}</span></div>
              <div class="hrow3">${date}</div>
            </div>
          </div>`;
      }).join('') || '<div class="hmeta">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';

      pager.innerHTML='';
      for(let i=1;i<=maxPages;i++){
        const b=ce('button',{textContent:String(i)});
        if(i===cur) b.className='on';
        b.onclick=()=>{cur=i;draw();};
        pager.append(b);
      }
    }
    draw();
  });
}

/* ===== ì°¨ëŸ‰ë³„ íˆìŠ¤í† ë¦¬ + ì‚­ì œ ===== */
function loadHistory(vehicle,force){
  const body=el('#histBody'); if(!body) return;
  fetchCsv(rows=>{
    const out = rows
      .filter((r,i)=> i>0 && String(r[1]||'').trim().toUpperCase()===vehicle)
      .slice(-30).reverse()
      .map(r=>{
        const date = fmtDateSmart(r[0]||'');
        const name = r[4]||'', dept=r[8]||'';
        const post = Number(r[5]||0);
        const day  = Number(r[6]||0);
        const memo = r[7]||'';
        const tsRaw = r[0] || '';
        return `
          <div class="hitem">
            <div class="kmcircle">${Number.isFinite(day)&&day>0 ? `${day}km` : 'â€”'}</div>
            <div class="hcell">
              <div class="hrow1">
                <div class="title">${name} Â· ${dept}</div>
                <div class="metaR">${Number.isFinite(post)?`ì£¼í–‰í›„ ${post}km`:''}</div>
              </div>
              <div class="hrow2">${memo ? `${memo}` : ''}</div>
              <div class="hrow3">${date}</div>
            </div>
            ${DELETE_URL ? `
              <button class="btn small" data-action="delete"
                data-ts="${String(tsRaw).replace(/"/g,'&quot;')}"
                data-vehicle="${vehicle}">ì‚­ì œ</button>` : ''}
          </div>`;
      }).join('') || '<div class="item meta">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    body.innerHTML=out;
  },force);
}

/* ===== UI í—¬í¼ ===== */
function field(label,input){ const w=ce('div',{style:'flex:1'}); w.append(ce('label',{textContent:label}),input); return w; }
function fieldLabelled(labelText,inputEl,required=false){ const wrap=ce('div',{style:'flex:1'}); const lab=ce('label',{textContent:labelText,className:required?'req':''}); wrap.append(lab,inputEl); return wrap; }

/* ===== ë”ë³´ê¸° íƒ­ ===== */
function renderMoreTab(){
  const page=el('#page'); page.innerHTML='';
  page.append(section('ë”ë³´ê¸°'));

  const grid=ce('div',{style:'display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:8px 12px'});
  function tile(label,icon,onclick){
    const b=ce('button',{className:'btn',style:'height:84px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:8px',onclick});
    b.innerHTML=`<svg class="ico" viewBox="0 0 24 24">${icon}</svg><div style="font-size:12px;font-weight:800;white-space:nowrap">${label}</div>`;
    return b;
  }
  grid.append(
    tile('ì…ë ¥ì •ë³´ ì´ˆê¸°í™”','<rect x="4" y="4" width="16" height="16" rx="4" fill="currentColor"/>',()=>{
      localStorage.removeItem('drive_userName');localStorage.removeItem('drive_dept');toast('ì´ë¦„/ë¶€ì„œ ì €ì¥ê°’ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
    }),
    tile('HOME í™”ë©´ QR','<path d="M3 3h18v18H3z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 7h3v3H7zM14 7h3v3h-3zM14 14h3v3h-3z" fill="currentColor"/>',openHomeQrModal),
    tile('ë©”ì¼ ë‹´ë‹¹ì','<path d="M3 5h18v14H3z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M3 6l9 6 9-6" fill="none" stroke="currentColor" stroke-width="2"/>',showContacts)
  );
  page.append(grid);

  const qrCard=ce('div',{className:'card'});
  qrCard.append(ce('div',{className:'section-title',textContent:'ì°¨ëŸ‰ë³„ QR'}));
  VEHICLES.forEach(v=>{
    const btn=ce('button',{className:'btn',style:'width:100%;justify-content:space-between;margin-top:6px',type:'button'});
    btn.innerHTML=`<span>${v.name} (${v.id})</span><span style="font-weight:800;color:#1b64da">QR</span>`;
    btn.onclick=()=>openQrModalForVehicle(v);
    qrCard.append(btn);
  });
  page.append(qrCard);
}
function showContacts(){
  if(!CONTACTS_CSV_URL){ toast('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì£¼ì†Œë¥¼ ì„¤ì •í•˜ì„¸ìš”.',false); return; }
  fetch(CONTACTS_CSV_URL).then(r=>r.text()).then(t=>{
    const rows=parseCSV(t).filter((r,i)=>i>0).map(r=>r[0]).filter(Boolean);
    alert('ë©”ì¼ ë‹´ë‹¹ì\n\n- '+rows.join('\n- '));
  }).catch(()=>toast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨',false));
}

/* ===== ê¸°ë¡ ë°˜ì˜ ëŒ€ê¸° ===== */
function waitUntilUpdated(vehicle,beforeCount,timeoutMs=12000){
  const started=Date.now();
  return new Promise((resolve)=>{
    const tick=()=>fetchCsv(rows=>{
      const cnt=rows.filter((r,i)=>i>0 && String(r[1]||'').toUpperCase()===vehicle).length;
      if(cnt>beforeCount) return resolve(true);
      if(Date.now()-started>timeoutMs) return resolve(false);
      setTimeout(tick,800);
    },true);
    tick();
  });
}

/* ===== ì‚­ì œ ë²„íŠ¼ ìœ„ì„ ===== */
document.addEventListener('click', (e) => {
  const b = e.target.closest('button[data-action="delete"]');
  if (!b) return;
  const ts = b.getAttribute('data-ts');
  const vehicle = b.getAttribute('data-vehicle');
  deleteAndRefresh(ts, vehicle, b);
});
async function deleteAndRefresh(ts, vehicle, btn){
  if(!DELETE_URL){ toast('ì‚­ì œURL ë¯¸ì„¤ì •',false); return; }
  if(!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?')) return;
  try{
    btn && (btn.disabled=true);
    const r=await fetch(DELETE_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ts,vehicle})});
    if(!r.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
    toast('ì‚­ì œ ì™„ë£Œ');
    setTimeout(()=>{ loadHistory(vehicle,true); if(location.hash==='#/recent') renderRecentTab(); },700);
  }catch(e){ toast('ì‚­ì œ ì˜¤ë¥˜: '+e.message,false); }
  finally{ btn && (btn.disabled=false); }
}

/* ===== ë‚ ì§œ íŒŒì„œ ===== */
function fmtDateSmart(s){
  if(s instanceof Date && !isNaN(s)) return ymdhm(s);
  if(/^\d+(\.\d+)?$/.test(String(s))){
    const d=new Date(Math.round((Number(s)-25569)*86400*1000));
    if(!isNaN(d)) return ymdhm(d);
  }
  const kr=String(s).trim();
  const m=kr.match(/^(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼\s*(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{2})/);
  if(m){
    let[,y,mo,d,ap,h,mi]=m; y=+y; mo=+mo; d=+d; h=+h; mi=+mi;
    if(ap==='ì˜¤í›„'&&h<12) h+=12;
    if(ap==='ì˜¤ì „'&&h===12) h=0;
    const dt=new Date(y,mo-1,d,h,mi);
    if(!isNaN(dt)) return ymdhm(dt);
  }
  const d2=new Date(s); if(!isNaN(d2)) return ymdhm(d2);
  return String(s);
}
function ymdhm(d){ const yoil=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()]; const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}(${yoil}) ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
</script>
</body>
</html>
