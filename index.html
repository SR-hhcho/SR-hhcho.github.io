<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#1b64da" />
<title>업무용 운행기록</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css"/>

<style>
:root{
  --bg:#f7f8fa; --card:#fff; --text:#111; --sub:#717680; --line:#e5e8eb;
  --blue:#1b64da; --blue-press:#1552b3; --ok:#12b886; --err:#f03e3e;
  --chip:#eef2ff; --chip-border:#dbe6ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:"Pretendard Variable",Pretendard,-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial,system-ui,sans-serif;
}
.wrap{min-height:100%;display:flex;flex-direction:column}

/* 아바타(홈 타일 썸네일) */
.avatar{width:36px;height:36px;border-radius:8px;object-fit:cover;border:1px solid var(--line)} 

/* 앱바 */
.appbar{position:sticky;top:0;z-index:60;height:56px;background:#fff;border-bottom:1px solid var(--line);
  display:grid;grid-template-columns:56px 1fr 56px;align-items:center}
.appbtn{display:flex;align-items:center;justify-content:center;height:56px;color:#1b64da;text-decoration:none;font-weight:800}
.apptitle{justify-self:center;font-weight:900;font-size:17px;letter-spacing:-0.3px}
.apptitle a{color:inherit;text-decoration:none}

/* 섹션 타이틀 */
.section-title{margin:10px 16px 4px;font-weight:900;color:#1b64da;font-size:13px}

/* 안내 캡션 */
.caption{color:var(--sub);font-size:13px;margin:6px 16px 8px}

/* 카드/폼 */
.card{background:#fff;margin:8px 12px;padding:14px;border-radius:14px;box-shadow:0 6px 24px rgba(17,17,17,.06)}
.row{display:flex;gap:8px}
label{display:block;font-size:12px;color:var(--sub);margin:8px 2px 4px}
label.req::after{content:" *";color:#1b64da;font-weight:900}  /* ⬅️ 필수표시 복구 */
input,textarea,select{
  width:100%;font-size:16px;padding:12px 12px;border-radius:12px;border:1px solid var(--line);
  background:#fff;outline:none;transition:border .15s,box-shadow .15s;font-family:inherit
}
input:focus,textarea:focus,select:focus{border-color:#b4c6ff;box-shadow:0 0 0 3px rgba(27,100,218,.15)}
textarea{height:44px;resize:none}

/* 운행전 km 배지 */
.prevkm{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:#1e40af;
  border:1px solid var(--chip-border);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;margin-top:6px}

/* 우측 미세 안내 */
.micro{margin-top:6px;margin-left:auto;color:#95a1ad;font-size:12px}

/* 버튼/액션 */
.actions{display:flex;gap:8px;margin:8px 12px;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--line);background:#fff;color:#374151;border-radius:12px;padding:10px 14px;font-size:14px;font-weight:800;text-decoration:none;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
.btn:hover{filter:brightness(0.98)}
.btn.ghost{background:#fff}
.sticky{position:sticky;bottom:64px;padding:10px 12px 16px;background:linear-gradient(180deg,rgba(247,248,250,0),var(--bg) 30%);margin-top:auto}
button.primary{width:100%;border:none;border-radius:14px;padding:14px 18px;font-size:17px;font-weight:900;color:#fff;background:var(--blue);box-shadow:0 10px 24px rgba(27,100,218,.25);cursor:pointer}
button.primary:active{background:var(--blue-press)}

/* 홈 타일 */
.list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;margin:8px 12px 84px}
.tile{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px;text-decoration:none;color:#111;display:flex;align-items:center;gap:12px;box-shadow:0 4px 14px rgba(0,0,0,.04)}
.tile img{width:44px;height:28px;object-fit:cover;border-radius:6px;border:1px solid var(--line)}
.tile-left{display:flex;align-items:center;gap:10px;min-width:0}
.plate{font-weight:900;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}
.idtag{font-size:11px;font-weight:800;color:#1e40af;background:#eef2ff;padding:2px 8px;border-radius:999px;border:1px solid #dbe6ff;white-space:nowrap}

/* 히스토리 카드 공통 */
.history{margin:8px 12px 84px;padding:10px;border:1px solid var(--line);border-radius:14px;background:#fff}
.hitem{display:flex;gap:12px;align-items:flex-start;padding:12px 4px;border-bottom:1px dashed var(--line)}
.hitem:last-child{border-bottom:none}

/* 왼쪽 동그란 km 뱃지 */
.kmcircle{
  min-width:48px;min-height:48px;border-radius:50%;
  background:#eef2ff;border:1.5px solid #c7d2fe;color:#1e40af;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;font-size:12px;box-shadow:0 4px 12px rgba(59,130,246,.08)
}

/* 가운데 본문(3줄) */
.hcell{flex:1;min-width:0}
.hrow1{display:flex;justify-content:space-between;gap:8px}
.hrow1 .title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hrow1 .metaR{color:#64748b;font-size:12px;white-space:nowrap}
.hrow2{color:#374151;font-size:12.5px;line-height:1.3;word-break:keep-all}
.hrow2 .postkm{font-weight:900;color:#111;margin-right:6px}
.hrow3{color:#6b7280;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* 삭제 버튼 작게 */
.btn.small{padding:6px 10px;font-size:12px}

/* ===== 차량 헤더(왼쪽 배지 2줄 + 오른쪽 설명 2줄) ===== */
.head-card{display:flex;gap:12px;align-items:center}
.vchip2{
  width:70px;height:70px;border-radius:16px;
  background:var(--chip);border:1px solid var(--chip-border);
  color:#1e40af;display:flex;flex-direction:column;justify-content:center;align-items:center;
  line-height:1.05;font-weight:900;box-shadow:0 4px 12px rgba(0,0,0,.04);text-align:center;padding:4px
}
.vchip2 .plate{font-size:13px;max-width:62px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.vchip2 .vid{font-size:10.5px;opacity:.85}

/* 오른쪽 설명: 2줄, 작은 폰트 */
.head-desc{
  margin-left:auto;max-width:calc(100% - 88px);
  font-size:12px;line-height:1.35;color:#4b5563
}

/* 하단 탭바 */
.tabbar{position:fixed;left:0;right:0;bottom:0;height:64px;background:#fff;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(4,1fr);z-index:50}
.tab{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:#6b7684;text-decoration:none;font-size:11px;font-weight:800}
.tab.on{color:#1b64da}
.ico{width:20px;height:20px}

/* 토스트 */
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#fff;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.08);padding:10px 12px;border-radius:12px;font-size:14px;display:none}
.toast.ok{border-color:#b2f2bb;color:#0c7;background:#f6fffa;display:block}
.toast.err{border-color:#ffc9c9;color:#d11;background:#fff5f5;display:block}

/* 로딩 오버레이 */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999}
.overlay.show{display:flex}
.overlay .box{background:#fff;padding:18px 20px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.12);display:flex;flex-direction:column;align-items:center;gap:10px;min-width:220px}
.spinner{width:28px;height:28px;border:3px solid #e5e8eb;border-top-color:#1b64da;border-radius:50%;animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.overlay .msg{font-weight:700;font-size:14px;color:#111}
.overlay .sub{font-size:12px;color:#6b7684;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="appbar">
    <a class="appbtn" href="#/"><svg class="ico" viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z" fill="currentColor"/></svg></a>
    <div class="apptitle"><a href="#/">업무용 운행기록</a></div>
    <div></div>
  </div>

  <div id="page"></div>
  <div id="toast" class="toast"></div>

  <!-- 로딩 오버레이 -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="box">
      <div class="spinner"></div>
      <div class="msg">처리 중…</div>
      <div class="sub">서버가 기록을 저장하는 중입니다.<br>잠시만 기다려주세요.</div>
    </div>
  </div>
</div>

<!-- 하단 탭 -->
<nav class="tabbar">
  <a href="#/" class="tab" id="tab-home"><svg class="ico" viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z" fill="currentColor"/></svg>HOME</a>
  <a href="#/sheet" class="tab" id="tab-sheet"><svg class="ico" viewBox="0 0 24 24"><path d="M5 3h10l4 4v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm10 1v4h4" fill="currentColor"/></svg>운행일지</a>
  <a href="#/recent" class="tab" id="tab-recent"><svg class="ico" viewBox="0 0 24 24"><path d="M12 8v5l4 2M4 12a8 8 0 1 0 8-8" stroke="currentColor" fill="none" stroke-width="2"/></svg>최근기록</a>
  <a href="#/more" class="tab" id="tab-more"><svg class="ico" viewBox="0 0 24 24"><circle cx="5" cy="12" r="2" fill="currentColor"/><circle cx="12" cy="12" r="2" fill="currentColor"/><circle cx="19" cy="12" r="2" fill="currentColor"/></svg>더보기</a>
</nav>

<script>
/* ===== 설정 ===== */
const WEBHOOK_URL  = "https://hook.us2.make.com/95cj2g36m4tsgu82h1bu41gf4swboiks";
const DELETE_URL   = "https://hook.us2.make.com/j2naw84osfkadkga7xkrljj8ep6rvroh";
const LOGS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLnxKDu-UGxyHZ86d5HS6G9_aFRvD5TEYFyMmqR-oFogtT1iNvhB08_BciXL2KsepJ_VihsO4qHVnF/pub?gid=0&single=true&output=csv";
const CONTACTS_CSV_URL = "";

/* 차량 등록 */
const VEHICLES = [
  { id:"V001", name:"806조8193", img:"img/V001.jpg" },
  { id:"V002", name:"81두1166", img:"img/V002.jpg" },
  { id:"V003", name:"804너3147", img:"img/V003.jpg" }
];

/* 허용 목록(전역) */
const NAME_ALLOW = ["김학철","최종우","권철운","이승훈","권태국","윤종선","한동훈","박남주","남광현","김대현","원동섭","조항현"];
const DEPT_ALLOW = ["안전관리팀","안전기술팀","영업공무팀"];

/* ===== 유틸 ===== */
const el=(s,p=document)=>p.querySelector(s);
const ce=(t,o={})=>Object.assign(document.createElement(t),o);
const toast=(m,ok=true)=>{const t=el('#toast');t.textContent=m;t.className='toast '+(ok?'ok':'err');setTimeout(()=>t.className='toast',2200);};
function setTab(name){['home','sheet','recent','more'].forEach(k=>el('#tab-'+k)?.classList.toggle('on',k===name));}
function section(title){return ce('div',{className:'section-title',textContent:title});}
function setLoading(on,msg){const ov=el('#overlay');if(!ov) return;ov.classList.toggle('show',!!on);if(msg) ov.querySelector('.msg').textContent=msg;document.querySelectorAll('input,textarea,button,select').forEach(e=>e.disabled=!!on);}

/* CSV 공통 */
function fetchCsv(done,force){
  if(!LOGS_CSV_URL){ done([['기록시각','차량ID','차량명','사용자ID','사용자명','계기판_km','일운행_km','메모','부서']]); return; }
  const url=LOGS_CSV_URL+(/\?/.test(LOGS_CSV_URL)?'&':'?')+'nocache='+(force?Date.now():'0');
  fetch(url).then(r=>r.text()).then(t=>done(parseCSV(t))).catch(()=>done([['기록시각','차량ID','차량명','사용자ID','사용자명','계기판_km','일운행_km','메모','부서']]));
}
function parseCSV(text){
  const rows=[];let row=[],cell='',q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(q){ if(c==='"'&&n!='"'){q=false;continue;} if(c==='"'&&n==='"'){cell+='"';i++;continue;} cell+=c; continue; }
    if(c===','){ row.push(cell); cell=''; continue; }
