<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <meta name="theme-color" content="#1b64da" />
  <title>업무용 운행기록</title>

  <!-- 폰트 -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.css"
        crossorigin>

  <style>
    :root{
      --bg:#f7f8fa; --card:#fff; --text:#111; --sub:#717680; --line:#e5e8eb;
      --blue:#1b64da; --blue-press:#1552b3; --ok:#12b886; --err:#f03e3e;
      --chip:#eef2ff; --chip-border:#dbe6ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:"Pretendard Variable",Pretendard,-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial,system-ui,sans-serif;
    }
    .wrap{min-height:100%;display:flex;flex-direction:column}

    /* 앱바 */
    .appbar{
      position:sticky;top:0;z-index:60;height:56px;background:#fff;
      border-bottom:1px solid var(--line);
      display:grid;grid-template-columns:56px 1fr 56px;align-items:center
    }
    .appbtn{
      display:flex;align-items:center;justify-content:center;height:56px;
      color:#1b64da;text-decoration:none;font-weight:800
    }
    .apptitle{
      justify-self:center;font-weight:900;font-size:17px;letter-spacing:-0.3px
    }
    .apptitle a{color:inherit;text-decoration:none}

    /* 섹션 타이틀 & 캡션 */
    .section-title{margin:10px 16px 4px;font-weight:900;color:#1b64da;font-size:13px}
    .caption{color:var(--sub);font-size:13px;margin:6px 16px 8px}

    /* 카드 */
    .card{
      background:#fff;margin:8px 12px;padding:14px;border-radius:14px;
      box-shadow:0 6px 24px rgba(17,17,17,.06)
    }
    .row{display:flex;gap:8px}
    label{
      display:block;font-size:12px;color:var(--sub);
      margin:8px 2px 4px;
      font-weight:700; /* ← 라벨(성명/부서/운행후km/비고) 굵기 */
    }
    label.req::after{content:" *";color:#1b64da;font-weight:900}
    input,textarea,select{
      width:100%;font-size:16px;padding:12px;border-radius:12px;
      border:1px solid var(--line);background:#fff;outline:none;
      transition:border .15s,box-shadow .15s;font-family:inherit;
      font-weight:700; /* ← 입력/선택 값도 굵게 */
    }
    input:focus,textarea:focus,select:focus{
      border-color:#b4c6ff;box-shadow:0 0 0 3px rgba(27,100,218,.15)
    }
    textarea{height:44px;resize:none}

    /* 운행전 */
    .prevkm{
      display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:#1e40af;
      border:1px solid var(--chip-border);padding:4px 10px;border-radius:999px;
      font-size:12px;font-weight:800;margin-top:6px
    }
    .micro{margin-top:6px;margin-left:auto;color:#95a1ad;font-size:12px}

    /* 액션 버튼 */
    .actions{display:flex;gap:8px;margin:8px 12px;flex-wrap:wrap}
    .btn{
      appearance:none;border:1px solid var(--line);background:#fff;color:#374151;
      border-radius:12px;padding:10px 14px;font-size:14px;font-weight:800;
      text-decoration:none;display:inline-flex;align-items:center;gap:8px;cursor:pointer
    }
    .btn:hover{filter:brightness(0.98)}
    .btn.ghost{background:#fff}
    .btn.small{padding:6px 10px;font-size:12px}

    .sticky{
      position:sticky;bottom:64px;padding:10px 12px 16px;
      background:linear-gradient(180deg,rgba(247,248,250,0),var(--bg) 30%);
      margin-top:auto
    }
    button.primary{
      width:100%;border:none;border-radius:14px;padding:14px 18px;font-size:17px;
      font-weight:900;color:#fff;background:var(--blue);
      box-shadow:0 10px 24px rgba(27,100,218,.25);cursor:pointer
    }
    button.primary:active{background:var(--blue-press)}

    /* 홈 리스트 */
    .list{display:flex;flex-direction:column;gap:10px;margin:8px 12px 84px}
    .tile{
      background:#fff;border:1px solid var(--line);border-radius:14px;
      padding:10px 12px;text-decoration:none;color:#111;
      display:flex;align-items:center;gap:12px;
      box-shadow:0 4px 14px rgba(0,0,0,.04)
    }
    .tile img{
      width:56px;height:36px;object-fit:cover;border-radius:8px;border:1px solid var(--line)
    }
    .tile-left{display:flex;align-items:center;gap:10px;min-width:0;flex:1}
    .plate{font-weight:900;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .idtag{
      font-size:11px;font-weight:800;color:#1e40af;background:#eef2ff;
      padding:4px 10px;border-radius:999px;border:1px solid #dbe6ff;white-space:nowrap
    }
    .qrchip{
      margin-left:auto;font-size:12px;font-weight:800;color:#1e40af;
      background:#f5f7ff;border-radius:999px;border:1px dashed #c7d2fe;
      padding:6px 14px;cursor:pointer
    }

    /* 차량 페이지 헤더 배지(축소) */
    .head-card{display:flex;gap:12px;align-items:center}
    .vchip2{
      min-width:110px;max-width:130px;height:48px;  /* 120에서 110 140에서 130 52에서 48(축소) */
      border-radius:14px;background:var(--chip);border:1px solid var(--chip-border);
      color:#1e40af;display:flex;flex-direction:column;justify-content:center;align-items:center;
      line-height:1.05;font-weight:900;box-shadow:0 4px 12px rgba(0,0,0,.04);
      text-align:center;padding:4px
    }
    .vchip2 .plate{font-size:15px}
    .vchip2 .vid{font-size:11px;opacity:.9}
    .head-desc{
      margin-left:auto;max-width:calc(100% - 150px);
      font-size:10px; /* ← 차량 페이지 안내문 폰트 크기 (원하면 10~13px 사이로 여기만 수정) */
      line-height:1.35;color:#4b5563
    }

    /* 히스토리 카드 */
    .history{
      margin:8px 12px 84px;padding:10px;border:1px solid var(--line);
      border-radius:14px;background:#fff
    }
    .hitem{display:flex;gap:12px;align-items:flex-start;padding:12px 4px;border-bottom:1px dashed var(--line)}
    .hitem:last-child{border-bottom:none}
    .kmcircle{
      min-width:48px;min-height:48px;border-radius:50%;
      background:#eef2ff;border:1.5px solid #c7d2fe;color:#1e40af;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:12px;box-shadow:0 4px 12px rgba(59,130,246,.08)
    }
    .hcell{flex:1;min-width:0}
    .hrow1{display:flex;justify-content:space-between;gap:8px}
    .hrow1 .title{
      font-weight:900;font-size:12px; /* ← 이름/부서 1pt 정도 줄임 */
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }
    .hrow1 .metaR{color:#64748b;font-size:11px;white-space:nowrap}
    .hrow2{color:#374151;font-size:12px;line-height:1.3;word-break:keep-all}
    .hrow2 .postkm{font-weight:400;color:#111;margin-left:4px} /* ← 700에서 400으로 정도 줄임 */
    .hrow3{color:#6b7280;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* 탭바 */
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;height:64px;background:#fff;
      border-top:1px solid var(--line);
      display:grid;grid-template-columns:repeat(4,1fr);z-index:50
    }
    .tab{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:4px;color:#6b7684;text-decoration:none;font-size:11px;font-weight:800
    }
    .tab.on{color:#1b64da}
    .ico{width:20px;height:20px}

    /* 토스트 */
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#fff;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.08);
      padding:10px 12px;border-radius:12px;font-size:14px;display:none;z-index:9999
    }
    .toast.ok{border-color:#b2f2bb;color:#0c7;background:#f6fffa;display:block}
    .toast.err{border-color:#ffc9c9;color:#d11;background:#fff5f5;display:block}

    /* 로딩 오버레이 */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;
      align-items:center;justify-content:center;z-index:9998
    }
    .overlay.show{display:flex}
    .overlay .box{
      background:#fff;padding:18px 20px;border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.12);
      display:flex;flex-direction:column;align-items:center;gap:10px;min-width:220px
    }
    .spinner{
      width:28px;height:28px;border:3px solid #e5e8eb;border-top-color:#1b64da;
      border-radius:50%;animation:spin .9s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .overlay .msg{font-weight:700;font-size:14px;color:#111}
    .overlay .sub{font-size:12px;color:#6b7684;text-align:center}

    /* QR 모달 */
    .qr-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.4);
      display:none;align-items:center;justify-content:center;z-index:9997
    }
    .qr-backdrop.show{display:flex}
    .qr-modal{
      background:#fff;border-radius:18px;padding:18px 18px 16px;
      max-width:360px;width:90%;box-shadow:0 20px 40px rgba(0,0,0,.25);
      display:flex;flex-direction:column;align-items:center;gap:14px
    }
    .qr-title{font-weight:900;font-size:16px;text-align:center}
    .qr-canvas-wrap{
      width:220px;height:220px;display:flex;align-items:center;justify-content:center
    }
    #qrImg{
      width:220px;height:220px;object-fit:contain;
    }
    .qr-buttons{display:flex;gap:10px;width:100%;margin-top:2px}
    .qr-buttons button{flex:1}

    /* 운행일지 요약 표 */
    table.summary{width:100%;border-collapse:collapse;font-size:13px}
    table.summary th,table.summary td{padding:6px 4px;border-bottom:1px solid #e5e7eb}
    table.summary th{text-align:left;color:#6b7280;font-weight:700;font-size:12px}
    table.summary td.num{text-align:right;font-variant-numeric:tabular-nums}

    /* 데스크탑 진입 막기 (desk=1 파라미터 없을 때) */
    @media (min-width:900px){
      body:not(.desk-ok)::before{
        content:"이 페이지는 모바일 전용입니다. URL 뒤에 ?desk=1 을 붙이면 PC에서도 테스트할 수 있습니다.";
        position:fixed;inset:0;background:#111;color:#fff;
        display:flex;align-items:center;justify-content:center;
        padding:40px;text-align:center;z-index:10000
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="appbar">
    <a class="appbtn" href="#/">
      <svg class="ico" viewBox="0 0 24 24">
        <path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z" fill="currentColor"/>
      </svg>
    </a>
    <div class="apptitle"><a href="#/">업무용 운행기록</a></div>
    <div></div>
  </div>

  <div id="page"></div>
  <div id="toast" class="toast"></div>

  <!-- 로딩 -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="box">
      <div class="spinner"></div>
      <div class="msg">처리 중…</div>
      <div class="sub">서버가 기록을 저장하는 중입니다.<br>잠시만 기다려주세요.</div>
    </div>
  </div>

  <!-- QR 모달 -->
  <div id="qrBackdrop" class="qr-backdrop">
    <div class="qr-modal">
      <div id="qrTitle" class="qr-title"></div>
      <div class="qr-canvas-wrap">
        <!-- ← 여기 이미지 src만 바꿔서 QR 표시 -->
        <img id="qrImg" alt="QR">
      </div>
      <div class="qr-buttons">
        <button id="qrDownload" class="btn">다운로드</button>
        <button id="qrClose" class="btn">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 탭 -->
<nav class="tabbar">
  <a href="#/" class="tab" id="tab-home">
    <svg class="ico" viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z" fill="currentColor"/></svg>HOME
  </a>
  <a href="#/sheet" class="tab" id="tab-sheet">
    <svg class="ico" viewBox="0 0 24 24"><path d="M5 3h10l4 4v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm10 1v4h4" fill="currentColor"/></svg>운행일지
  </a>
  <a href="#/recent" class="tab" id="tab-recent">
    <svg class="ico" viewBox="0 0 24 24"><path d="M12 8v5l4 2M4 12a8 8 0 1 0 8-8" stroke="currentColor" fill="none" stroke-width="2"/></svg>최근기록
  </a>
  <a href="#/more" class="tab" id="tab-more">
    <svg class="ico" viewBox="0 0 24 24"><circle cx="5" cy="12" r="2" fill="currentColor"/><circle cx="12" cy="12" r="2" fill="currentColor"/><circle cx="19" cy="12" r="2" fill="currentColor"/></svg>더보기
  </a>
</nav>

<script>
/* ===== 기본 설정 ===== */
const WEBHOOK_URL  = "https://hook.us2.make.com/95cj2g36m4tsgu82h1bu41gf4swboiks";
const DELETE_URL   = "https://hook.us2.make.com/j2naw84osfkadkga7xkrljj8ep6rvroh";
const LOGS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLnxKDu-UGxyHZ86d5HS6G9_aFRvD5TEYFyMmqR-oFogtT1iNvhB08_BciXL2KsepJ_VihsO4qHVnF/pub?gid=0&single=true&output=csv";
const CONTACTS_CSV_URL = "";

/* 차량 등록 + 이름표 */
const VEHICLES = [
  { id:"V001", name:"806조8193", img:"img/V001.jpg", label:"스타리아" },
  { id:"V002", name:"81두1166", img:"img/V002.jpg", label:"스타렉스" },
  { id:"V003", name:"804너3147", img:"img/V003.jpg", label:"스타리아" }
];

/* 허용 목록 */
const NAME_ALLOW = ["김학철","최종우","권철운","이승훈","권태국","윤종선","한동훈","박남주","남광현","김대현","원동섭","조항현"];
const DEPT_ALLOW = ["안전관리팀","안전기술팀","영업공무팀"];

/* ===== 헬퍼 ===== */
const el=(s,p=document)=>p.querySelector(s);
const ce=(t,o={})=>Object.assign(document.createElement(t),o);
const toast=(m,ok=true)=>{
  const t=el('#toast'); t.textContent=m;
  t.className='toast '+(ok?'ok':'err');
  setTimeout(()=>t.className='toast',2200);
};
function setTab(name){
  ['home','sheet','recent','more'].forEach(k=>{
    el('#tab-'+k)?.classList.toggle('on',k===name);
  });
}
function section(title){return ce('div',{className:'section-title',textContent:title});}
function setLoading(on,msg){
  const ov=el('#overlay'); if(!ov) return;
  ov.classList.toggle('show',!!on);
  if(msg) ov.querySelector('.msg').textContent=msg;
}

/* CSV 로딩 */
function fetchCsv(done,force){
  if(!LOGS_CSV_URL){
    done([['기록시각','차량ID','차량명','사용자ID','사용자명','계기판_km','일운행_km','메모','부서']]);
    return;
  }
  const url=LOGS_CSV_URL+(/\?/.test(LOGS_CSV_URL)?'&':'?')+'nocache='+(force?Date.now():'0');
  fetch(url).then(r=>r.text()).then(t=>done(parseCSV(t))).catch(()=>{
    done([['기록시각','차량ID','차량명','사용자ID','사용자명','계기판_km','일운행_km','메모','부서']]);
  });
}
function parseCSV(text){
  const rows=[];let row=[],cell='',q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(q){
      if(c==='"'&&n!='"'){q=false;continue;}
      if(c==='"'&&n==='"'){cell+='"';i++;continue;}
      cell+=c; continue;
    }
    if(c===','){ row.push(cell); cell=''; continue; }
    if(c==='\n'){ row.push(cell); rows.push(row); row=[]; cell=''; continue; }
    if(c==='"'){ q=true; continue; }
    if(c!=='\r') cell+=c;
  }
  row.push(cell); rows.push(row); return rows;
}

/* ===== 라우터 ===== */
function route(){
  const seg=(location.hash||'#/').slice(2).split('/').filter(Boolean);
  const first=seg[0]||'';
  if(!first){ renderHome(); setTab('home'); return; }
  if(first==='sheet'){ renderSheetTab(); setTab('sheet'); return; }
  if(first==='recent'){ renderRecentTab(); setTab('recent'); return; }
  if(first==='more'){ renderMoreTab(); setTab('more'); return; }
  renderVehicle(first.toUpperCase()); setTab('home');
}
window.addEventListener('hashchange',route);
if(!location.hash) location.hash = '#/';
route();

/* ===== 홈 ===== */
function renderHome(){
  const page=el('#page'); page.innerHTML='';
  page.append(ce('p',{className:'caption',textContent:'차량을 선택해 기록하세요.'}));
  const list=ce('div',{className:'list'});
  VEHICLES.forEach(v=>{
    const a=ce('a',{className:'tile',href:'#/'+encodeURIComponent(v.id)});
    const left=ce('div',{className:'tile-left'});
    const img=ce('img',{src:v.img||''});
    img.onerror=function(){
      const s=this.src;
      if(/\.png$/i.test(s)) this.src=s.replace(/\.png$/i,'.jpg');
      else if(/\.jpg$/i.test(s)) this.src=s.replace(/\.jpg$/i,'.png');
      else this.remove();
    };
    left.append(img,ce('span',{className:'plate',textContent:v.name}));
    const idTag=ce('span',{className:'idtag',textContent:v.id});
    const qrBtn=ce('button',{className:'qrchip',type:'button',textContent:'QR'});
    qrBtn.onclick=(e)=>{
      e.preventDefault();
      openQrModal(`${v.name} (${v.id}) 페이지 QR`, location.origin+location.pathname+`#/${v.id}`);
    };
    a.append(left,idTag,qrBtn);
    list.append(a);
  });
  page.append(list);
}

/* ===== 차량 페이지 ===== */
function field(label,input){ const w=ce('div',{style:'flex:1'}); w.append(ce('label',{textContent:label}),input); return w; }
function fieldLabelled(labelText,inputEl,required=false){
  const wrap=ce('div',{style:'flex:1'});
  const lab=ce('label',{textContent:labelText,className:required?'req':''});
  wrap.append(lab,inputEl); return wrap;
}

function renderVehicle(vehicle){
  const v = VEHICLES.find(x=>x.id===vehicle) || {id:vehicle,name:'',label:''};
  const page = el('#page'); page.innerHTML='';

  const head = ce('div',{className:'card head-card'});
  const vchip = ce('div',{className:'vchip2'});
  vchip.innerHTML = `
    <div class="plate">${v.name || vehicle}</div>
    <div class="vid">${vehicle} (${v.label||''})</div>
  `;
  const desc = ce('div',{className:'head-desc'});
  desc.innerHTML = '운행후 km와 운행목적을 입력해주세요.<br>이름/부서는 최초 1회만 저장하시면 됩니다.';
  head.append(vchip,desc);
  page.append(head);

  const card=ce('div',{className:'card'});
  const row1=ce('div',{className:'row'});
  const nameSel=ce('select',{id:'userName'});
  nameSel.append(ce('option',{value:'',textContent:'성명 선택'}));
  NAME_ALLOW.forEach(n=>nameSel.append(ce('option',{value:n,textContent:n})));
  const deptSel=ce('select',{id:'dept'});
  deptSel.append(ce('option',{value:'',textContent:'부서 선택'}));
  DEPT_ALLOW.forEach(d=>deptSel.append(ce('option',{value:d,textContent:d})));
  row1.append(
    fieldLabelled('성명',nameSel,true),
    fieldLabelled('부서',deptSel,true)
  );
  card.append(row1);

  const row2=ce('div',{className:'row'});
  const odoI=ce('input',{id:'odo',type:'number',inputMode:'numeric',placeholder:'예) 26400'});
  const memoI=ce('textarea',{id:'memo',placeholder:'시설점검 등'});
  row2.append(
    fieldLabelled('운행 후 km(숫자)',odoI,true),
    field('비고(선택)',memoI)
  );
  card.append(row2);

  const meta=ce('div',{style:'display:flex;align-items:center;gap:8px'});
  const prevBadge=ce('span',{className:'prevkm',textContent:'운행 전: 확인중…'});
  const micro=ce('div',{className:'micro',textContent:'내 정보는 이 기기에만 저장됩니다.'});
  meta.append(prevBadge,micro);
  card.append(meta);
  page.append(card);

  const actions=ce('div',{className:'actions'});
  const backBtn=ce('a',{className:'btn ghost',href:'#/'}); backBtn.textContent='← 홈으로';
  const resetBtn=ce('button',{className:'btn',type:'button'}); resetBtn.textContent='내 정보 초기화';
  const refreshBtn=ce('button',{className:'btn',type:'button'}); refreshBtn.textContent='새로고침';
  actions.append(backBtn,resetBtn,refreshBtn);
  page.append(actions);

  const sticky=ce('div',{className:'sticky'});
  const submit=ce('button',{className:'primary',type:'button',textContent:'제출하기'});
  sticky.append(submit); page.append(sticky);

  // 로컬 저장 복원
  const keyN='drive_userName', keyD='drive_dept';
  const savedN=localStorage.getItem(keyN), savedD=localStorage.getItem(keyD);
  if(savedN && NAME_ALLOW.includes(savedN)) nameSel.value=savedN;
  if(savedD && DEPT_ALLOW.includes(savedD)) deptSel.value=savedD;

  resetBtn.onclick=()=>{
    localStorage.removeItem(keyN); localStorage.removeItem(keyD);
    nameSel.value=''; deptSel.value='';
    toast('저장된 이름/부서를 삭제했습니다.');
  };

  refreshBtn.onclick=()=>{
    setLoading(true,'새로고침 중…');
    refreshPrev(true);
    loadHistory(vehicle,true);
    setTimeout(()=>setLoading(false),400);
  };

  odoI.addEventListener('focus',()=>setTimeout(()=>odoI.scrollIntoView({behavior:'smooth',block:'center'}),150));

  submit.onclick=async ()=>{
    const userName=nameSel.value;
    const dept=deptSel.value;
    const odo=odoI.value.trim();
    const memo=memoI.value.trim();
    if(!userName){toast('성명을 선택해주세요',false);nameSel.focus();return;}
    if(!dept){toast('부서를 선택해주세요',false);deptSel.focus();return;}
    if(!odo||isNaN(+odo)){toast('운행 후 km(숫자)를 입력해주세요',false);odoI.focus();return;}
    if(!NAME_ALLOW.includes(userName)){toast('성명은 목록에서 선택해주세요.',false);return;}
    if(!DEPT_ALLOW.includes(dept)){toast('부서는 목록에서 선택해주세요.',false);return;}

    localStorage.setItem(keyN,userName);
    localStorage.setItem(keyD,dept);

    let beforeCount=0;
    await new Promise(res=>fetchCsv(rows=>{
      beforeCount = rows.filter((r,i)=>i>0 && String(r[1]||'').toUpperCase()===vehicle).length;
      res();
    },true));

    setLoading(true,'기록을 저장하는 중입니다…');
    try{
      const resp=await fetch(WEBHOOK_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({vehicle,userName,dept,odo,memo})
      });
      if(!resp.ok) throw new Error('네트워크 오류');

      const ok=await waitUntilUpdated(vehicle,beforeCount,15000);

      odoI.value=''; memoI.value=''; odoI.focus();
      await refreshPrev(true);
      loadHistory(vehicle,true);
      setTimeout(()=>{refreshPrev(true);loadHistory(vehicle,true);},1200);

      toast(ok?'전송 완료! ✅':'전송은 완료, 반영 대기 중입니다.',ok);
    }catch(e){
      toast('전송 실패: '+e.message,false);
    }finally{
      setLoading(false);
    }
  };

  function refreshPrev(force){
    return new Promise(res=>{
      fetchCsv(rows=>{
        let last=null;
        for(let i=rows.length-1;i>=1;i--){
          const r=rows[i];
          if(String(r[1]||'').toUpperCase()===vehicle){ last=r; break; }
        }
        if(last){
          const post=Number(last[5]||'');
          prevBadge.textContent = Number.isFinite(post) ? `운행 전: ${post} km` : '운행 전: —';
        }else{
          prevBadge.textContent='운행 전: (첫 기록)';
        }
        res();
      },force);
    });
  }
  refreshPrev();

  const histCard=ce('div',{className:'history'});
  histCard.append(ce('div',{className:'section-title',textContent:'최근 기록'}));
  histCard.append(ce('div',{id:'histBody'}));
  page.insertBefore(histCard,sticky);
  loadHistory(vehicle);

  startPolling('VEH:'+vehicle);
}

/* ===== 최근기록 탭 ===== */
function renderRecentTab(){
  const page=el('#page'); page.innerHTML='';
  page.append(section('최근기록'));

  const box=ce('div',{className:'history'});
  box.innerHTML='<div id="recentList"></div>';
  const pager=ce('div',{id:'pager',style:'margin:8px 0;display:flex;gap:4px;justify-content:center'});
  page.append(box,pager);

  fetchCsv(rows=>{
    const items=rows.filter((r,i)=>i>0).reverse();
    const per=10, maxPages=Math.min(5,Math.ceil(items.length/per)||1);
    let cur=1;
    function draw(){
      const slice=items.slice((cur-1)*per,(cur-1)*per+per);
      el('#recentList').innerHTML = slice.map(r=>{
        const date=fmtDateSmart(r[0]||'');
        const vid=r[1]||'';
        const vname=(VEHICLES.find(v=>v.id===vid)?.name)||vid;
        const name=r[4]||'', dept=r[8]||'';
        const post=Number(r[5]||0), day=Number(r[6]||0), memo=r[7]||'';
        return `
          <div class="hitem">
            <div class="kmcircle">${Number.isFinite(day)&&day>0 ? `${day}km` : '—'}</div>
            <div class="hcell">
              <div class="hrow1">
                <div class="title">${name} · ${dept}</div>
                <div class="metaR">${vname}</div>
              </div>
              <div class="hrow2">
                ${memo ? memo : ''}<span class="postkm">${Number.isFinite(post)?`주행후 ${post}km`:''}</span>
              </div>
              <div class="hrow3">${date}</div>
            </div>
          </div>`;
      }).join('') || '<div class="hmeta">기록이 없습니다.</div>';

      pager.innerHTML='';
      for(let i=1;i<=maxPages;i++){
        const b=ce('button',{textContent:String(i),className:'btn small'});
        if(i===cur) b.style.background='#1b64da', b.style.color='#fff';
        b.onclick=()=>{cur=i;draw();};
        pager.append(b);
      }
    }
    draw();
  });

  startPolling('RECENT');
}

/* ===== 차량별 히스토리 ===== */
function loadHistory(vehicle,force){
  const body=el('#histBody'); if(!body) return;
  fetchCsv(rows=>{
    const out = rows
      .filter((r,i)=>i>0 && String(r[1]||'').trim().toUpperCase()===vehicle)
      .slice(-30).reverse()
      .map(r=>{
        const date=fmtDateSmart(r[0]||'');
        const name=r[4]||'', dept=r[8]||'';
        const post=Number(r[5]||0), day=Number(r[6]||0), memo=r[7]||'';
        const tsRaw=r[0]||'';
        return `
          <div class="hitem">
            <div class="kmcircle">${Number.isFinite(day)&&day>0 ? `${day}km` : '—'}</div>
            <div class="hcell">
              <div class="hrow1">
                <div class="title">${name} · ${dept}</div>
                <div class="metaR"></div>
              </div>
              <div class="hrow2">
                ${memo ? memo : ''}<span class="postkm">${Number.isFinite(post)?`주행후 ${post}km`:''}</span>
              </div>
              <div class="hrow3">${date}</div>
            </div>
            ${DELETE_URL ? `
              <button class="btn small" data-action="delete"
                data-ts="${String(tsRaw).replace(/"/g,'&quot;')}"
                data-vehicle="${vehicle}">삭제</button>` : ''}
          </div>`;
      }).join('') || '<div class="item meta">기록이 없습니다.</div>';
    body.innerHTML=out;
  },force);
}

/* ===== 운행일지 요약 ===== */
function renderSheetTab(){
  const page=el('#page'); page.innerHTML='';
  page.append(section('차량별 운행 요약'));
  page.append(ce('p',{className:'caption',textContent:'스프레드시트 로그를 기준으로 차량별 총 운행거리(km)를 보여줍니다.'}));

  const card=ce('div',{className:'card'});
  const table=ce('table',{className:'summary'});
  table.innerHTML='<thead><tr><th>차량</th><th>차량ID</th><th class="num">총 운행거리(km)</th></tr></thead><tbody></tbody>';
  const tbody=table.querySelector('tbody');
  card.append(table); page.append(card);

  fetchCsv(rows=>{
    const byVid={};
    rows.slice(1).forEach(r=>{
      const vid=(r[1]||'').toUpperCase();
      const day=Number(r[6]||0);
      if(!vid||!Number.isFinite(day)) return;
      byVid[vid]=(byVid[vid]||0)+day;
    });
    VEHICLES.forEach(v=>{
      const tr=ce('tr');
      tr.innerHTML=`<td>${v.name} (${v.label})</td><td>${v.id}</td><td class="num">${byVid[v.id]||0}</td>`;
      tbody.append(tr);
    });
  });
}

/* ===== 더보기 탭 ===== */
function renderMoreTab(){
  const page=el('#page'); page.innerHTML='';
  page.append(section('더보기'));

  const card=ce('div',{className:'card'});
  const list=ce('div',{style:'display:flex;flex-direction:column;gap:10px'});

  const btnReset=ce('button',{className:'btn',type:'button',textContent:'입력정보 전체 초기화'});
  btnReset.onclick=()=>{
    localStorage.removeItem('drive_userName'); localStorage.removeItem('drive_dept');
    toast('이름/부서 저장값을 삭제했습니다.');
  };
  list.append(btnReset);

  const btnHomeQr=ce('button',{className:'btn',type:'button',textContent:'HOME 화면 QR'});
  btnHomeQr.onclick=()=>openQrModal('HOME 화면 QR', location.origin+location.pathname+'#/');
  list.append(btnHomeQr);

  const title=ce('div',{style:'margin-top:8px;font-size:13px;font-weight:700;color:#374151',textContent:'차량별 QR'});
  list.append(title);

  VEHICLES.forEach(v=>{
    const b=ce('button',{className:'btn small',type:'button'});
    b.style.justifyContent='space-between';
    b.innerHTML=`<span>${v.name} (${v.id})</span><span style="font-size:12px;color:#1b64da;font-weight:800">QR 보기</span>`;
    b.onclick=()=>openQrModal(`${v.name} (${v.id}) 페이지 QR`, location.origin+location.pathname+`#/${v.id}`);
    list.append(b);
  });

  card.append(list); page.append(card);
}

/* ===== QR 모달 ===== */
function openQrModal(title,url){
  const backdrop=el('#qrBackdrop');
  const titleEl=el('#qrTitle');
  const img=el('#qrImg');

  titleEl.textContent=title;

  // 무료 QR 이미지 API 사용
  const apiUrl='https://api.qrserver.com/v1/create-qr-code/?size=220x220&data='+encodeURIComponent(url);
  img.src=apiUrl;

  backdrop.classList.add('show');

  const downloadBtn=el('#qrDownload');
  const closeBtn=el('#qrClose');

  downloadBtn.onclick=()=>{
    const a=document.createElement('a');
    a.download='qr_'+Date.now()+'.png';
    a.href=apiUrl;
    document.body.appendChild(a);
    a.click();
    a.remove();
  };
  closeBtn.onclick=()=>backdrop.classList.remove('show');
  backdrop.onclick=(e)=>{ if(e.target===backdrop) backdrop.classList.remove('show'); };
}

/* ===== 삭제 버튼 위임 ===== */
document.addEventListener('click', (e)=>{
  const b=e.target.closest('button[data-action="delete"]');
  if(!b) return;
  const ts=b.getAttribute('data-ts');
  const vehicle=b.getAttribute('data-vehicle');
  deleteAndRefresh(ts,vehicle,b);
});
async function deleteAndRefresh(ts,vehicle,btn){
  if(!DELETE_URL){toast('삭제URL 미설정',false);return;}
  if(!confirm('이 기록을 삭제할까요?')) return;
  try{
    btn && (btn.disabled=true);
    const r=await fetch(DELETE_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ts,vehicle})
    });
    if(!r.ok) throw new Error('삭제 실패');
    toast('삭제 완료');
    setTimeout(()=>refreshAfterChange(vehicle),700);
  }catch(e){
    toast('삭제 오류: '+e.message,false);
  }finally{
    btn && (btn.disabled=false);
  }
}

/* ===== 반영 대기 폴링 ===== */
let _pollTimer=null;
let _lastStamp='';
function calcStamp(rows,vehicle){
  if(!rows||rows.length<=1) return '';
  if(vehicle){
    for(let i=rows.length-1;i>=1;i--){
      const r=rows[i];
      if((r[1]||'').toUpperCase()===vehicle){
        return String(r[0]||'')+'|'+String(r[5]||'')+'|'+String(r[6]||'');
      }
    }
    return '';
  }else{
    const r=rows[rows.length-1]||[];
    return String(r[0]||'')+'|'+String(r[1]||'')+'|'+String(r[5]||'')+'|'+String(r[6]||'');
  }
}
function startPolling(key){
  stopPolling();
  const isVehicle=key && key.startsWith('VEH:');
  const vehicle=isVehicle?key.slice(4):null;
  fetchCsv(rows=>{_lastStamp=calcStamp(rows,vehicle);},true);
  _pollTimer=setInterval(()=>{
    fetchCsv(rows=>{
      const now=calcStamp(rows,vehicle);
      if(now && now!==_lastStamp){
        _lastStamp=now;
        if(isVehicle) refreshAfterChange(vehicle);
        else if(location.hash==='#/recent') renderRecentTab();
      }
    },true);
  },10000);
}
function stopPolling(){ if(_pollTimer){clearInterval(_pollTimer);_pollTimer=null;} }

function waitUntilUpdated(vehicle,beforeCount,timeoutMs=12000){
  const started=Date.now();
  return new Promise(resolve=>{
    const tick=()=>fetchCsv(rows=>{
      const cnt=rows.filter((r,i)=>i>0 && String(r[1]||'').toUpperCase()===vehicle).length;
      if(cnt>beforeCount) return resolve(true);
      if(Date.now()-started>timeoutMs) return resolve(false);
      setTimeout(tick,800);
    },true);
    tick();
  });
}
function refreshAfterChange(vehicle){
  if(vehicle) loadHistory(vehicle,true);
  if(location.hash==='#/recent') renderRecentTab();
}

/* ===== 날짜 포맷 ===== */
function fmtDateSmart(s){
  if(s instanceof Date && !isNaN(s)) return ymdhm(s);
  if(/^\d+(\.\d+)?$/.test(String(s))){
    const d=new Date(Math.round((Number(s)-25569)*86400*1000));
    if(!isNaN(d)) return ymdhm(d);
  }
  const kr=String(s).trim();
  const m=kr.match(/^(\d{4})년\s*(\d{1,2})월\s*(\d{1,2})일\s*(오전|오후)\s*(\d{1,2}):(\d{2})/);
  if(m){
    let[,y,mo,d,ap,h,mi]=m; y=+y; mo=+mo; d=+d; h=+h; mi=+mi;
    if(ap==='오후'&&h<12) h+=12;
    if(ap==='오전'&&h===12) h=0;
    const dt=new Date(y,mo-1,d,h,mi);
    if(!isNaN(dt)) return ymdhm(dt);
  }
  const d2=new Date(s); if(!isNaN(d2)) return ymdhm(d2);
  return String(s);
}
function ymdhm(d){
  const yoil=['일','월','화','수','목','금','토'][d.getDay()];
  const pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}(${yoil}) ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* ===== 데스크탑 예외 허용 (?desk=1) ===== */
(function(){
  const params=new URLSearchParams(location.search);
  if(params.get('desk')==='1'){ document.body.classList.add('desk-ok'); }
})();
</script>
</body>
</html>



