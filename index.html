<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#1b64da" />
<title>업무용 운행기록</title>

<!-- Pretendard -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css"/>

<style>
:root{
  --bg:#f7f8fa; --card:#fff; --text:#111; --sub:#717680; --line:#e5e8eb;
  --blue:#1b64da; --blue-press:#1552b3; --ok:#12b886; --err:#f03e3e; --radius:16px;
  --chip:#eef2ff; --chip-border:#dbe6ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:"Pretendard Variable",Pretendard,-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial,system-ui,sans-serif;
}
.wrap{min-height:100%;display:flex;flex-direction:column}

.avatar{width:36px;height:36px;border-radius:8px;object-fit:cover;border:1px solid var(--line)} 

/* 최근기록 폰트/줄간 간격 살짝 축소 */ 
.history{font-size:12.5px}
.item{font-size:12.5px; line-height:1.28}
.meta{font-size:11.5px}
.k{font-size:11px; padding:2px 6px}

/* 앱바 */
.appbar{position:sticky;top:0;z-index:60;height:56px;background:#fff;border-bottom:1px solid var(--line);
  display:grid;grid-template-columns:56px 1fr 56px;align-items:center}
.appbtn{display:flex;align-items:center;justify-content:center;height:56px;color:#1b64da;text-decoration:none;font-weight:800}
.apptitle{justify-self:center;font-weight:900;font-size:17px;letter-spacing:-0.3px}
.apptitle a{color:inherit;text-decoration:none}

/* 섹션 타이틀(탭 안쪽 상단 표시) */
.section-title{margin:10px 16px 4px;font-weight:900;color:#1b64da;font-size:13px}

/* 안내 캡션 */
.caption{color:var(--sub);font-size:13px;margin:6px 16px 8px}

/* 차량 배지 */
.vehicle-chip{margin:0 16px 8px;display:inline-flex;align-items:center;gap:8px;
  background:var(--chip);color:#1e40af;padding:6px 10px;border:1px solid var(--chip-border);border-radius:999px;font-weight:800;font-size:12px}

/* 카드/폼 */
.card{background:#fff;margin:8px 12px;padding:14px;border-radius:14px;box-shadow:0 6px 24px rgba(17,17,17,.06)}
.row{display:flex;gap:8px}
label{display:block;font-size:12px;color:var(--sub);margin:8px 2px 4px}
input,textarea,select{
  width:100%;font-size:16px;padding:12px 12px;border-radius:12px;border:1px solid var(--line);
  background:#fff;outline:none;transition:border .15s,box-shadow .15s;font-family:inherit
}
input:focus,textarea:focus,select:focus{border-color:#b4c6ff;box-shadow:0 0 0 3px rgba(27,100,218,.15)}
textarea{height:44px;resize:none} /* 1줄 높이로 고정 */

/* 운행전 km 배지 (입력 아래 왼쪽) */
.prevkm{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:#1e40af;
  border:1px solid var(--chip-border);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;margin-top:6px}

/* 우측 미세 안내 */
.micro{margin-top:6px;margin-left:auto;color:#95a1ad;font-size:12px}

/* 버튼/액션 */
.actions{display:flex;gap:8px;margin:8px 12px}
.btn{appearance:none;border:1px solid var(--line);background:#fff;color:#374151;border-radius:12px;padding:10px 14px;font-size:14px;font-weight:800;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.btn:hover{filter:brightness(0.98)}
.btn.ghost{background:#fff}
.sticky{position:sticky;bottom:64px;padding:10px 12px 16px;background:linear-gradient(180deg,rgba(247,248,250,0),var(--bg) 30%);margin-top:auto}
button.primary{width:100%;border:none;border-radius:14px;padding:14px 18px;font-size:17px;font-weight:900;color:#fff;background:var(--blue);box-shadow:0 10px 24px rgba(27,100,218,.25);cursor:pointer}
button.primary:active{background:var(--blue-press)}

/* 홈 타일 */
.list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;margin:8px 12px 84px}
.tile{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px;text-decoration:none;color:#111;display:flex;align-items:center;gap:12px;box-shadow:0 4px 14px rgba(0,0,0,.04)}
.tile img{width:44px;height:28px;object-fit:cover;border-radius:6px;border:1px solid var(--line)}
.tile-main{display:flex;flex-direction:column;gap:2px}
.plate{font-weight:900;font-size:15px}
.idtag{font-size:11px;font-weight:800;color:#1e40af;background:#eef2ff;padding:2px 8px;border-radius:999px;border:1px solid #dbe6ff;align-self:flex-start}

  /* 홈 타일 — 한 줄 유지 & 줄임표 */
.tile{
  display:flex;
  justify-content:space-between; /* 좌우 정렬 */
  align-items:center;
}

/* 왼쪽 묶음(이미지+차량명) */
.tile-left{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;                 /* ★ 줄임표가 먹게 하는 핵심 */
}

/* 차량명은 한 줄 + 넘치면 … */
.plate{
  font-weight:900;
  font-size:15px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:60vw;              /* 필요 시 55~65vw로 조절 */
}

/* ID 태그도 줄바꿈 금지 */
.idtag{
  white-space:nowrap;
}


/* 히스토리 카드(차량 페이지) */
.history{margin:8px 12px 84px;padding:10px;border:1px solid var(--line);border-radius:14px;background:#fff}
.hitem{display:flex;gap:10px;align-items:flex-start;padding:10px 4px;border-bottom:1px dashed var(--line)}
.hitem:last-child{border-bottom:none}
.kpill{min-width:44px;text-align:center;font-weight:800;color:#1e40af;background:#eef2ff;border:1px solid #dbe6ff;padding:2px 8px;border-radius:999px;font-size:11px}
.hmeta{color:#6b7684;font-size:12px}
.hline{font-size:13px;line-height:1.35}

/* 운행일지 탭 테이블(컴팩트) */
.table{width:100%;border-collapse:collapse;font-size:13px;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
.table th{background:#f1f3f5;font-weight:800;color:#333}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin:8px 12px 84px}
.mini{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;text-decoration:none;color:#111;font-weight:800}

/* 페이지네이션 */
.pager{display:flex;gap:8px;justify-content:center;margin:10px 0 84px}
.pager button{appearance:none;border:1px solid var(--line);background:#fff;border-radius:8px;padding:8px 10px;font-weight:800;cursor:pointer}
.pager .on{background:#1b64da;color:#fff;border-color:#1b64da}

/* 하단 탭바 */
.tabbar{position:fixed;left:0;right:0;bottom:0;height:64px;background:#fff;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(4,1fr);z-index:50}
.tab{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:#6b7684;text-decoration:none;font-size:11px;font-weight:800}
.tab.on{color:#1b64da}
.ico{width:20px;height:20px}

/* 토스트 */
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#fff;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.08);padding:10px 12px;border-radius:12px;font-size:14px;display:none}
.toast.ok{
  border-color:#b2f2bb;
  color:#0c7;
  background:#f6fffa;   /* 성공: 연한 그린 배경 */
  display:block;
}
.toast.err{
  border-color:#ffc9c9;
  color:#d11;
  background:#fff5f5;   /* 실패: 연한 레드 배경 */
  display:block;
}


.avatar{width:36px;height:36px;border-radius:8px;object-fit:cover;border:1px solid var(--line)}

/* === 로딩 오버레이 === */
.overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.35);
  display: none; align-items: center; justify-content: center;
  z-index: 9999;
}
.overlay.show { display: flex; }
.overlay .box {
  background: #fff; padding: 18px 20px; border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,.12);
  display: flex; flex-direction: column; align-items: center; gap: 10px;
  min-width: 220px;
}
.spinner {
  width: 28px; height: 28px; border: 3px solid #e5e8eb;
  border-top-color: #1b64da; border-radius: 50%;
  animation: spin 0.9s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.overlay .msg { font-weight: 700; font-size: 14px; color:#111; }
.overlay .sub { font-size: 12px; color:#6b7684; text-align:center; }

/* 드롭다운(Select) 스타일 - 앱 전체 톤 앤 매너 */
select.select {
  width:100%;
  appearance:none;
  background:#fff url('data:image/svg+xml;utf8,<svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="%236b7684" d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center / 16px;
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px 36px 12px 12px;
  font-size:15px; /* 이름 3글자, 부서 5글자 기준 살짝 컴팩트 */
  font-family:inherit;
}
select.select:focus {
  border-color:#b4c6ff;
  box-shadow:0 0 0 3px rgba(27,100,218,.15);
}

/* 라벨에 파란 * 표기 */
label.req::after{
  content:" *";
  color:#1b64da;
  font-weight:900;
}

/* 삭제 버튼 클릭감을 확실히 */
.btn.small {
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
}

  
</style>
</head>
<body>
<div class="wrap">
  <div class="appbar">
    <a class="appbtn" href="#/"><svg class="ico" viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z" fill="currentColor"/></svg></a>
    <div class="apptitle"><a href="#/">업무용 운행기록</a></div>
    <div></div>
  </div>

  <div id="page"></div>
  <div id="toast" class="toast"></div>

  <div id="overlay" class="overlay" aria-hidden="true">
  <div class="box">
    <div class="spinner"></div>
    <div class="msg">처리 중…</div>
    <div class="sub">서버가 기록을 저장하는 중입니다.<br>잠시만 기다려주세요.</div>
  </div>
</div>

  
</div>

<!-- 하단 탭 -->
<nav class="tabbar">
  <a href="#/" class="tab" id="tab-home"><svg class="ico" viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z" fill="currentColor"/></svg>HOME</a>
  <a href="#/sheet" class="tab" id="tab-sheet"><svg class="ico" viewBox="0 0 24 24"><path d="M5 3h10l4 4v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm10 1v4h4" fill="currentColor"/></svg>운행일지</a>
  <a href="#/recent" class="tab" id="tab-recent"><svg class="ico" viewBox="0 0 24 24"><path d="M12 8v5l4 2M4 12a8 8 0 1 0 8-8" stroke="currentColor" fill="none" stroke-width="2"/></svg>최근기록</a>
  <a href="#/more" class="tab" id="tab-more"><svg class="ico" viewBox="0 0 24 24"><circle cx="5" cy="12" r="2" fill="currentColor"/><circle cx="12" cy="12" r="2" fill="currentColor"/><circle cx="19" cy="12" r="2" fill="currentColor"/></svg>더보기</a>
</nav>

<script>
/* ===== 설정 (여기만 바꿔주면 됨) ===== */
const WEBHOOK_URL  = "https://hook.us2.make.com/95cj2g36m4tsgu82h1bu41gf4swboiks";         // 등록용
const DELETE_URL   = "https://hook.us2.make.com/j2naw84osfkadkga7xkrljj8ep6rvroh";   // 삭제용(아래 안내)
const LOGS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLnxKDu-UGxyHZ86d5HS6G9_aFRvD5TEYFyMmqR-oFogtT1iNvhB08_BciXL2KsepJ_VihsO4qHVnF/pub?gid=0&single=true&output=csv";
const CONTACTS_CSV_URL = ""; // (선택) 담당자 메일리스트 CSV 퍼블릭 주소 넣으면 더보기 탭에 표시


  
// 차량 등록 (작은 이미지가 있으면 img에 경로)
const VEHICLES = [
  { id:"V001", name:"806조8193", img:"img/V001.jpg" },
  { id:"V002", name:"81두1166", img:"img/V002.jpg" },
  { id:"V003", name:"804너3147", img:"img/V003.jpg" }
];

// 허용 목록 (여기에만 추가/수정하면 드롭다운에 반영됩니다)
const NAME_ALLOW = ["김학철","최종우","권철운","이승훈","권태국","윤종선","한동훈","박남주","남광현","김대현","원동섭","조항현"];
const DEPT_ALLOW = ["안전관리팀","안전기술팀","영업공무팀"];


/* ===== 유틸 ===== */
const el=(s,p=document)=>p.querySelector(s);
const ce=(t,o={})=>Object.assign(document.createElement(t),o);
const toast=(m,ok=true)=>{const t=el('#toast');t.textContent=m;t.className='toast '+(ok?'ok':'err');setTimeout(()=>t.className='toast',2200);};
const fmtDate=(iso)=>{ // 'YYYY/MM/DD(요일) HH:mm'
  const d=new Date(iso||Date.now());
  const yo=['일','월','화','수','목','금','토'][d.getDay()];
  const z=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())}(${yo}) ${z(d.getHours())}:${z(d.getMinutes())}`;
};
function setTab(name){['home','sheet','recent','more'].forEach(k=>el('#tab-'+k)?.classList.toggle('on',k===name));}
function section(title){return ce('div',{className:'section-title',textContent:title});}
function refreshAfterChange(vehicle){
    if (vehicle) { loadHistory(vehicle, true); }   // 차량 화면이면 해당 히스토리 갱신
    if (location.hash === '#recent') { renderRecentTab(); } // 최근기록 탭 열려 있으면 재그리기
  }

function setLoading(on, msg) {
  const ov = document.getElementById('overlay');
  if (!ov) return;
  ov.classList.toggle('show', !!on);
  if (msg) ov.querySelector('.msg').textContent = msg;
  // 입력 잠금
  const dis = !!on;
  document.querySelectorAll('input, textarea, button').forEach(el => {
    if (el.id !== 'overlay') el.disabled = dis;
  });
}

function waitUntilUpdated(vehicle, beforeCount, timeoutMs=12000) {
  // CSV를 계속 폴링하며 해당 vehicle 건수가 증가하면 resolve
  const started = Date.now();
  return new Promise((resolve, reject) => {
    const tick = () => {
      fetchCsv(rows => {
        const cnt = rows.filter((r,i)=> i>0 && String(r[1]||'').toUpperCase()===vehicle).length;
        if (cnt > beforeCount) return resolve(true);
        if (Date.now() - started > timeoutMs) return resolve(false); // 타임아웃은 실패로 처리
        setTimeout(tick, 800);
      }, /*force*/ true);
    };
    tick();
  });
}

  
  async function deleteAndRefresh(ts, vehicle, btn){
    if (!DELETE_URL){ toast('삭제URL 미설정', false); return; }
    if (!confirm('이 기록을 삭제할까요?')) return;

    try{
      if (btn) btn.disabled = true;
      const r = await fetch(DELETE_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ ts, vehicle })
      });
      if(!r.ok) throw new Error('삭제 실패');
      toast('삭제 완료');
      // 0.7초 쉬고 최신 데이터 반영
      setTimeout(function(){ refreshAfterChange(vehicle); }, 700);
    }catch(e){
      toast('삭제 오류: '+e.message, false);
    }finally{
      if (btn) btn.disabled = false;
    }
  }
  
/* ===== 라우터 (해시 기반: #/, #/V001, #/sheet ...) ===== */
function route(){
  const seg = (location.hash||'#/').slice(2).split('/').filter(Boolean);
  const first = seg[0]||'';
  if (!first) { renderHome(); setTab('home'); return; }
  if (first==='sheet'){ renderSheetTab(); setTab('sheet'); return; }
  if (first==='recent'){ renderRecentTab(); setTab('recent'); return; }
  if (first==='more'){ renderMoreTab(); setTab('more'); return; }
  // 차량 ID로 간주
  renderVehicle(first.toUpperCase()); setTab('home');
}
window.addEventListener('hashchange',route);
route();

/* ===== 홈 ===== */
function renderHome(){
  var page = el('#page'); page.innerHTML = '';
  var p1 = ce('p',{className:'caption',textContent:'차량을 선택해 기록하세요.'});

  var grid = ce('div',{className:'list'});
  VEHICLES.forEach(function(v){
    var a = ce('a',{className:'tile', href: '#/' + encodeURIComponent(v.id)});

    var img = ce('img',{className:'avatar', src: v.img || ''});
    img.onerror = function(){
      const s = this.src;
      if (/\.png$/i.test(s)) this.src = s.replace(/\.png$/i,'.jpg');
      else if (/\.jpg$/i.test(s)) this.src = s.replace(/\.jpg$/i,'.png');
      else this.remove();
    };

    var left = ce('div',{className:'tile-left'});

    left.append(img, ce('span',{className:'plate',textContent:(v.name||'')}));
    var right = ce('span',{className:'idtag',textContent:v.id});
    a.append(left, right);
    grid.append(a);
  });

  page.append(p1, grid);
}



/* ===== 차량 페이지 ===== */
function renderVehicle(vehicle){
  const v=VEHICLES.find(x=>x.id===vehicle)||{id:vehicle,name:''};
  const page=el('#page'); page.innerHTML='';

  // 상단 요약(차량 왼쪽, 설명 오른쪽)
  const head=ce('div',{className:'card',style:'display:flex;gap:10px;align-items:flex-start'});
  head.append(ce('div',{className:'vehicle-chip',textContent:`${v.name||vehicle} · ${vehicle}`}));
  const desc=ce('div',{className:'caption',style:'margin:0;align-self:center'});
  desc.textContent='운행 후 km(숫자)와 운행목적(비고)을 입력해주세요. 이름/부서는 최초 1회만 저장됩니다.';
  head.append(desc);
  page.append(head);

  // 입력 카드
  const card=ce('div',{className:'card'});

// --- 성명/부서 (Select UI) ---
const row = ce('div',{className:'row'});

const nameSel = ce('select',{id:'userName', className:'select'});
nameSel.append(ce('option',{value:'', textContent:'성명 선택'}));
NAME_ALLOW.forEach(n=> nameSel.append(ce('option',{value:n, textContent:n})));

const deptSel = ce('select',{id:'dept', className:'select'});
deptSel.append(ce('option',{value:'', textContent:'부서 선택'}));
DEPT_ALLOW.forEach(d=> deptSel.append(ce('option',{value:d, textContent:d})));

row.append(
  fieldLabelled('성명', nameSel, /*required=*/true),
  fieldLabelled('부서', deptSel, /*required=*/true)
);
card.append(row);

  // 운행 후/비고 (같은 줄)
  const row2=ce('div',{className:'row'});
  const odoI=ce('input',{id:'odo',type:'number',inputMode:'numeric',placeholder:'예) 21840'});
  const memoI=ce('textarea',{id:'memo',placeholder:'시설점검 등'}); // 1줄 고정
  row2.append(field('운행 후 km(숫자)',odoI), field('비고(선택)',memoI));
  card.append(row2);

  // 운행 전 km 배지 + 우측 미세 안내
  const meta=ce('div',{style:'display:flex;align-items:center;gap:8px'});
  const prevBadge=ce('span',{className:'prevkm',textContent:'운행 전: 확인중…'});
  const micro=ce('div',{className:'micro',textContent:'내 정보는 이 기기에만 저장됩니다.'});
  meta.append(prevBadge); meta.append(micro);
  card.append(meta);

  page.append(card);

  // 액션
  const actions=ce('div',{className:'actions'});
  const backBtn=ce('a',{className:'btn ghost',href:'#/'}); backBtn.textContent='← 홈으로';
  const resetBtn=ce('button',{className:'btn',type:'button'}); resetBtn.textContent='내 정보 초기화';
  actions.append(backBtn,resetBtn);
  page.append(actions);

  const sticky=ce('div',{className:'sticky'});
  const submit=ce('button',{className:'primary',textContent:'제출하기',type:'button'});
  sticky.append(submit);
  page.append(sticky);

// 저장값 로드
const keyN='drive_userName', keyD='drive_dept';
const savedN = localStorage.getItem(keyN), savedD = localStorage.getItem(keyD);
if (savedN && NAME_ALLOW.includes(savedN)) nameSel.value = savedN;
if (savedD && DEPT_ALLOW.includes(savedD)) deptSel.value = savedD;

// 초기화
resetBtn.onclick = () => {
  localStorage.removeItem(keyN); localStorage.removeItem(keyD);
  nameSel.value=''; deptSel.value='';
  toast('저장된 이름/부서를 삭제했습니다.');
};

// 모바일에서 km 입력 시 자동 스크롤
odoI.addEventListener('focus',()=>{
  setTimeout(()=>odoI.scrollIntoView({behavior:'smooth',block:'center'}),150);
});

// 제출
submit.onclick = async () => {
  const userName = nameSel.value;
  const dept     = deptSel.value;
  const odo      = odoI.value.trim();
  const memo     = memoI.value.trim();

  if(!userName){ toast('성명을 선택해주세요', false); nameSel.focus(); return; }
  if(!dept){     toast('부서를 선택해주세요', false);  deptSel.focus(); return; }
  if(!odo || isNaN(+odo)){ toast('운행 후 km(숫자)를 입력해주세요', false); odoI.focus(); return; }

  localStorage.setItem(keyN, userName);
  localStorage.setItem(keyD, dept);

  // 전송 직전: 해당 차량의 기존 건수 카운트
  let beforeCount = 0;
  await new Promise(res => fetchCsv(rows => {
    beforeCount = rows.filter((r,i)=>i>0 && String(r[1]||'').toUpperCase()===vehicle).length;
    res();
  }, true));

  // 전송 시작: 로딩 띄우고 입력 잠금
  setLoading(true, '기록을 저장하는 중입니다…');

  try{
    // Webhook 전송
    const resp = await fetch(WEBHOOK_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ vehicle, userName, dept, odo, memo })
    });
    if(!resp.ok) throw new Error('네트워크 오류');

    // 시트 반영될 때까지 폴링 (최대 15초)
    const ok = await waitUntilUpdated(vehicle, beforeCount, 15000);

    // 입력창 초기화 & 즉시 반영 시도
    odoI.value=''; memoI.value=''; odoI.focus();
    refreshPrev(true);
    loadHistory(vehicle, true);

    // 자동 새로고침(추가 반영)
    setTimeout(() => refreshAfterChange(vehicle), 1200);

    toast(ok ? '전송 완료! ✅' : '전송은 완료, 반영 대기 중입니다.', ok);
  }catch(e){
    toast('전송 실패: ' + e.message, false);
  }finally{
    setLoading(false);
  }
};


  // 필수 검증
  if(!NAME_ALLOW.includes(userName)){ toast('성명은 목록에서 선택해주세요.', false); nameI.focus(); return; }
  if(!DEPT_ALLOW.includes(dept)){ toast('부서는 목록에서 선택해주세요.', false);  deptI.focus(); return; }
  if(!odo || isNaN(+odo)){ toast('운행 후 km(숫자)를 입력해주세요', false); odoI.focus(); return; }

  // 로컬 저장
  localStorage.setItem(keyN, userName);
  localStorage.setItem(keyD, dept);

  // 전송 직전: 해당 차량의 기존 건수 카운트
  let beforeCount = 0;
  await new Promise(res => fetchCsv(rows => {
    beforeCount = rows.filter((r,i)=>i>0 && String(r[1]||'').toUpperCase()===vehicle).length;
    res();
  }, true));

  // 전송 시작: 로딩 띄우고 입력 잠금
  setLoading(true, '기록을 저장하는 중입니다…');

  try{
    // Webhook 전송
    const resp = await fetch(WEBHOOK_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ vehicle, userName, dept, odo, memo })
    });
    if(!resp.ok) throw new Error('네트워크 오류');

    // 시트 반영될 때까지 폴링 (최대 15초)
    const ok = await waitUntilUpdated(vehicle, beforeCount, 15000);

    // 입력창 초기화 & 즉시 반영 시도
    odoI.value=''; memoI.value=''; odoI.focus();
    refreshPrev(true);
    loadHistory(vehicle, true);

    // 자동 새로고침(추가 반영)
    setTimeout(() => refreshAfterChange(vehicle), 1200);

    toast(ok ? '전송 완료! ✅' : '전송은 완료, 반영 대기 중입니다.', ok);
  }catch(e){
    toast('전송 실패: ' + e.message, false);
  }finally{
    setLoading(false);
  }
};



  // 운행 전 km 표시
  function refreshPrev(force){
    fetchCsv(rows=>{
      let last=null;
      for(let i=rows.length-1;i>=1;i--){
        const r=rows[i];
        if(String(r[1]||'').toUpperCase()===vehicle){ last=r; break; }
      }
      if(last){
        const pre=Number(last[5]||'');
        prevBadge.textContent = Number.isFinite(pre)? `운행 전: ${pre} km` : '운행 전: —';
      }else prevBadge.textContent='운행 전: (첫 기록)';
    },force);
  }
  refreshPrev();

  /* 차량 최근 기록 카드 */
  const histCard=ce('div',{className:'history'});
  histCard.append(ce('div',{className:'section-title',textContent:'최근 기록'}));
  histCard.append(ce('div',{id:'histBody'}));
  page.insertBefore(histCard,sticky);
  loadHistory(vehicle);

}

/* ===== 운행일지 탭 ===== */
function renderSheetTab(){
  const page=el('#page'); page.innerHTML='';
  page.append(section('운행일지'));
  page.append(ce('p',{className:'caption',textContent:'차량을 선택해 “운행일지 양식”을 읽기 모드로 확인하세요.'}));
  const grid=ce('div',{className:'grid'});
  VEHICLES.forEach(v=>{
    const a=ce('a',{className:'mini',href:'#',onclick:e=>{e.preventDefault();openSheetView(v.id,v.name);} });
    a.textContent=`${v.name} (${v.id})`;
    grid.append(a);
  });
  page.append(grid,ce('div',{id:'sheetView',className:'card'}));
}

function openSheetView(vehicle,vname){
  const host=el('#sheetView'); host.innerHTML='';
  host.append(section(`${vname} · ${vehicle}`));
  fetchCsv(rows=>{
    const body=rows.filter((r,i)=>i>0 && String(r[1]||'').toUpperCase()===vehicle);
    const table=ce('table',{className:'table'});
    table.innerHTML='<thead><tr><th>일자</th><th>부서</th><th>성명</th><th>주행전</th><th>주행후</th><th>주행거리</th><th>비고</th></tr></thead><tbody></tbody>';
    const tb=table.querySelector('tbody');
    body.forEach(r=>{
      const date=fmtDateSmart(r[0]||''), dept=r[8]||'', name=r[4]||'', post=Number(r[5]||0), day=Number(r[6]||0), memo=r[7]||'';
      const pre=(Number.isFinite(post)&&Number.isFinite(day))?(post-day):'';
      const tr=ce('tr');
      tr.innerHTML=`<td>${date}</td><td>${dept}</td><td>${name}</td><td>${pre}</td><td>${post}</td><td>${day}</td><td>${memo}</td>`;
      tb.append(tr);
    });
    host.append(table);
  });
}

/* ===== 최근기록 탭 (전 차량, 10개/페이지) ===== */
function renderRecentTab(){
  const page=el('#page'); page.innerHTML='';
  page.append(section('최근기록'));
  const box=ce('div',{className:'history'}); box.innerHTML='<div id="recentList"></div>';
  const pager=ce('div',{className:'pager',id:'pager'});
  page.append(box,pager);

  fetchCsv(rows=>{
    const items=rows.filter((r,i)=>i>0).reverse();
    const per=10, maxPages=Math.min(5,Math.ceil(items.length/per)||1);
    let cur=1;
    function draw(){
      const slice=items.slice((cur-1)*per,(cur-1)*per+per);
   el('#recentList').innerHTML = slice.map(r=>{
  const date = fmtDateSmart(r[0]||'');
  const vid  = r[1]||'';
  const vname= (VEHICLES.find(v=>v.id===vid)?.name) || vid;
  const name = r[4]||'', dept=r[8]||'';
  const post = Number(r[5]||0), day=Number(r[6]||0), memo=r[7]||'';
  const pre  = (Number.isFinite(post) && Number.isFinite(day)) ? (post - day) : null;

  return `
    <div class="hitem">
      <div class="kpill">${Number.isFinite(day) && day>0 ? `${day}km` : '—'}</div>
      <div class="hline" style="flex:1">
        <div class="hmeta">${vname} · ${date}</div>
        <div><strong style="font-weight:900">${name}</strong> · ${dept} · 주행후 ${post}km${pre!=null ? ` · 운행전 ${pre}km` : ''}${memo ? ` · ${memo}` : ''}</div>
      </div>
    </div>`;
}).join('') || '<div class="hmeta">기록이 없습니다.</div>';

      pager.innerHTML='';
      for(let i=1;i<=maxPages;i++){
        const b=ce('button',{textContent:String(i)});
        if(i===cur) b.className='on';
        b.onclick=()=>{cur=i;draw();};
        pager.append(b);
      }
    }
    draw();
  });
}

/* ===== 더보기 탭 ===== */
function renderMoreTab(){
  const page=el('#page'); page.innerHTML='';
  page.append(section('더보기'));
  const grid=ce('div',{style:'display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 12px 84px'});
  function tile(label,icon,onclick){
    const b=ce('button',{className:'btn',style:'height:84px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:8px',onclick});
    b.innerHTML=`<svg class="ico" viewBox="0 0 24 24">${icon}</svg><div style="font-size:12px;font-weight:800;white-space:nowrap">${label}</div>`;
    return b;
  }
  grid.append(
    tile('입력정보 초기화','<rect x="4" y="4" width="16" height="16" rx="4" fill="currentColor"/>',()=>{
      localStorage.removeItem('drive_userName');localStorage.removeItem('drive_dept');toast('이름/부서 저장값을 삭제했습니다.');
    }),
    tile('메일 담당자 확인','<path d="M3 5h18v14H3z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M3 6l9 6 9-6" fill="none" stroke="currentColor" stroke-width="2"/>',showContacts),
    tile('준비중','<circle cx="12" cy="12" r="8" fill="currentColor"/>',()=>toast('준비중입니다.'))
  );
  page.append(grid);
}

/* ===== 차량별 히스토리(상세) + 삭제 버튼 ===== */
function loadHistory(vehicle, force){
  var body = el('#histBody'); if(!body) return;
  fetchCsv(function(rows){
    const out = rows
      .filter((r,i)=> i>0 && String(r[1]||'').trim().toUpperCase()===vehicle)
      .slice(-30).reverse()
      .map(r=>{
        const date = fmtDateSmart(r[0]||'');   // ← 날짜 포맷 적용
        const name = r[4]||'', dept=r[8]||'', odo=r[5]||'', day=r[6]||'', memo=r[7]||'';
        const tsRaw = r[0] || '';
        return `
          <div class="item">
            <span class="k">${day? (day+'km') : '—'}</span>
            <div style="flex:1;">
              <div><strong>${name}</strong> · ${dept} · <span class="meta">${date}</span></div>
              <div class="meta">주행후 ${odo}km${memo? ' · '+memo:''}</div>
            </div>
${DELETE_URL ? `
  <button class="btn small"
    data-action="delete"
    data-ts="${String(tsRaw).replace(/"/g,'&quot;')}"
    data-vehicle="${vehicle}">
    삭제
  </button>` : ''}

          </div>`;
      }).join('') || '<div class="item meta">기록이 없습니다.</div>';
    body.innerHTML = out;
  }, force);
}


/* ===== CSV 공통 ===== */
function fetchCsv(done,force){
  if(!LOGS_CSV_URL){ done([['기록시각','차량ID','차량명','사용자ID','사용자명','계기판_km','일운행_km','메모','부서']]); return; }
  const url=LOGS_CSV_URL+(/\?/.test(LOGS_CSV_URL)?'&':'?')+'nocache='+(force?Date.now():'0');
  fetch(url).then(r=>r.text()).then(t=>done(parseCSV(t))).catch(()=>done([['기록시각','차량ID','차량명','사용자ID','사용자명','계기판_km','일운행_km','메모','부서']]));
}
function parseCSV(text){
  const rows=[];let row=[],cell='',q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(q){ if(c==='"'&&n!='"'){q=false;continue;} if(c==='"'&&n==='"'){cell+='"';i++;continue;} cell+=c; continue; }
    if(c===','){ row.push(cell); cell=''; continue; }
    if(c==='\n'){ row.push(cell); rows.push(row); row=[]; cell=''; continue; }
    if(c==='"'){ q=true; continue; }
    if(c!=='\r') cell+=c;
  }
  row.push(cell); rows.push(row); return rows;
}

/* ===== UI 헬퍼 ===== */
function field(label,input){
  const w=ce('div',{style:'flex:1'});
  w.append(ce('label',{textContent:label}),input);
  return w;
}

function fieldLabelled(labelText, inputEl, required=false){
  const wrap = ce('div',{style:'flex:1'});
  const lab = ce('label',{textContent:labelText, className: required ? 'req' : ''});
  wrap.append(lab, inputEl);
  return wrap;
}

function addDatalist(input, items){
  const id='dl_'+Math.random().toString(36).slice(2);
  const dl=ce('datalist',{id}); items.forEach(v=>dl.append(ce('option',{value:v}))); document.body.append(dl);
  input.setAttribute('list',id);
}

/* ===== 더보기: 메일 담당자 표시 ===== */
function showContacts(){
  if(!CONTACTS_CSV_URL){ toast('스프레드시트 주소를 설정하세요.',false); return; }
  fetch(CONTACTS_CSV_URL).then(r=>r.text()).then(t=>{
    const rows=parseCSV(t).filter((r,i)=>i>0).map(r=>r[0]).filter(Boolean);
    alert('메일 담당자\n\n- '+rows.join('\n- '));
  }).catch(()=>toast('불러오기 실패',false));
}

  // ... 기존 코드 위아래 상관없음 (전역 범위에) 추가
  function refreshAfterChange(vehicle){
    // 차량 상세 화면이면 그 차량 히스토리만 새로고침
    if (vehicle) { loadHistory(vehicle, true); }

    // 최근기록 탭이 열려 있으면 다시 그리기
    if (location.hash === '#recent') { renderRecentTab(); }
  }

function fmtDateSmart(s){
  // Date 객체
  if (s instanceof Date && !isNaN(s)) return ymdhm(s);

  // Google 시리얼 숫자
  if (/^\d+(\.\d+)?$/.test(String(s))) {
    const d = new Date(Math.round((Number(s) - 25569) * 86400 * 1000));
    if (!isNaN(d)) return ymdhm(d);
  }

  // "2025년 10월 16일 오전 12:30" 형태 파싱
  const kr = String(s).trim();
  const m = kr.match(/^(\d{4})년\s*(\d{1,2})월\s*(\d{1,2})일\s*(오전|오후)\s*(\d{1,2}):(\d{2})/);
  if (m){
    let [_, y, mo, d, ap, h, mi] = m;
    y=+y; mo=+mo; d=+d; h=+h; mi=+mi;
    if (ap==='오후' && h<12) h+=12;
    if (ap==='오전' && h===12) h=0;
    const dt = new Date(y, mo-1, d, h, mi);
    if(!isNaN(dt)) return ymdhm(dt);
  }

  // ISO/기타 파싱 시도
  const d2 = new Date(s);
  if (!isNaN(d2)) return ymdhm(d2);

  return String(s);
}
function ymdhm(d){
  const yoil = ['일','월','화','수','목','금','토'][d.getDay()];
  const pad = n => String(n).padStart(2, '0');
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}(${yoil}) ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

// 전역 클릭 리스너 (삭제 버튼용)
document.addEventListener('click', (e) => {
  const b = e.target.closest('button[data-action="delete"]');
  if (!b) return; // 클릭한 게 삭제버튼이 아니면 무시
  const ts = b.getAttribute('data-ts');
  const vehicle = b.getAttribute('data-vehicle');
  deleteAndRefresh(ts, vehicle, b); // 기존 함수 실행
});

  
</script>
</body>
</html>

















